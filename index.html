<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>넷폼알앤디 KPI 대시보드 v16</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* 라이트 모드 - 토스 컬러 시스템 */
            --bg: #f7f8fa;
            --bg-elevated: #ffffff;
            --blue: #3182f6;
            --blue-light: #e8f3ff;
            --blue-dark: #1b64da;
            --green: #00c471;
            --green-light: #e5f9ed;
            --red: #f04452;
            --red-light: #ffebee;
            --orange: #ff8a00;
            --orange-light: #fff3e0;
            --text-primary: #191f28;
            --text-secondary: #4e5968;
            --text-tertiary: #8b95a1;
            --text-disabled: #b0b8c1;
            --border: #e5e8eb;
            --border-light: #f2f4f6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        /* 다크 모드 */
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-elevated: #1a1a1a;
            --blue: #3182f6;
            --blue-light: rgba(49, 130, 246, 0.15);
            --blue-dark: #4593fc;
            --green: #00c471;
            --green-light: rgba(0, 196, 113, 0.15);
            --red: #f04452;
            --red-light: rgba(240, 68, 82, 0.15);
            --orange: #ff8a00;
            --orange-light: rgba(255, 138, 0, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #b0b8c1;
            --text-tertiary: #6b7684;
            --text-disabled: #4e5968;
            --border: #2a2a2a;
            --border-light: #1f1f1f;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ========== 레이아웃 ========== */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* ========== 프레젠테이션 모드 ========== */
        .presentation-mode .sidebar {
            display: none !important;
        }

        .presentation-mode .hero-title {
            font-size: 36px;
        }

        .presentation-mode .stat-value {
            font-size: 48px;
        }

        .presentation-mode .dept-name {
            font-size: 20px;
        }

        .presentation-mode .dept-pct {
            font-size: 36px;
        }

        .presentation-mode .winner-score {
            font-size: 40px;
        }

        .presentation-mode .chart-area {
            height: 350px;
        }

        .presentation-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--blue);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            z-index: 9999;
            display: none;
        }

        .presentation-mode .presentation-indicator {
            display: block;
        }

        /* ========== 사이드바 (다크 네이비) ========== */
        .sidebar {
            width: 240px;
            min-width: 240px;
            background: #0f172a;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            border-right: none;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 10px;
        }

        .logo-img {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            object-fit: contain;
            background: white;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .logo-text {
            font-size: 15px;
            font-weight: 700;
            color: white;
        }

        .logo-text span {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }

        .nav-section { margin-bottom: 20px; }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            padding: 0 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255,255,255,0.7);
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: #3B82F6;
            color: white;
            font-weight: 600;
        }

        /* 알림 배지 */
        .alert-badge {
            width: 20px;
            height: 20px;
            background: var(--red);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }

        .user-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .user-role { font-size: 12px; color: var(--text-tertiary); }

        /* ========== 메인 ========== */
        .main {
            flex: 1;
            overflow-y: auto;
        }

        /* ========== 상단 슬로건 히어로 배너 ========== */
        .top-slogan-bar {
            background: linear-gradient(135deg, #3182f6 0%, #1b64da 50%, #0050c8 100%);
            padding: 40px 48px;
            text-align: center;
            position: relative;
        }

        .top-slogan-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 50%, rgba(255,255,255,0.08) 0%, transparent 40%);
            pointer-events: none;
        }

        .slogan-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }

        .slogan-company {
            font-size: 15px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 2px;
            margin-bottom: 14px;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        .slogan-main {
            font-size: 32px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
            line-height: 1.3;
            margin-bottom: 24px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .slogan-main::before {
            content: '"';
            opacity: 0.6;
        }

        .slogan-main::after {
            content: '"';
            opacity: 0.6;
        }

        .slogan-highlight {
            color: #fef08a;
        }

        .slogan-progress-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .slogan-progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .slogan-progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .slogan-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
        }

        .slogan-current {
            font-weight: 700;
            font-size: 18px;
            color: white;
        }

        .slogan-target {
            color: rgba(255, 255, 255, 0.6);
        }

        .slogan-achievement {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        /* 다크모드 슬로건 배너 */
        [data-theme="dark"] .top-slogan-bar {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d2137 100%);
        }

        /* 프레젠테이션 모드 */
        .presentation-mode .top-slogan-bar {
            padding: 56px 48px;
        }

        .presentation-mode .slogan-main {
            font-size: 44px;
        }

        .presentation-mode .slogan-company {
            font-size: 18px;
        }

        .presentation-mode .slogan-stats {
            font-size: 18px;
        }

        .presentation-mode .slogan-current {
            font-size: 24px;
        }

        /* ========== 히어로 ========== */
        .hero {
            background: var(--bg-elevated);
            padding: 32px 48px;
            border-bottom: 1px solid var(--border);
        }

        /* 새로운 그라데이션 히어로 스타일 */
        .hero-gradient {
            background: var(--bg-elevated);
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border-light);
            border-radius: 0;
            padding: 24px 48px;
        }

        .hero-gradient::before {
            display: none;
        }

        .hero-gradient::after {
            display: none;
        }

        /* 추가 물결 레이어 */
        .hero-wave-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='rgba(255,255,255,0.05)' d='M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,90.7C672,85,768,107,864,128C960,149,1056,171,1152,165.3C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
            pointer-events: none;
        }

        .hero-gradient .hero-top {
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 24px;
        }

        .hero-gradient .hero-title {
            color: var(--text-primary);
            font-size: 38px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .hero-gradient .hero-slogan {
            color: var(--text-secondary);
            font-size: 22px;
            font-weight: 500;
            margin-top: 10px;
        }

        .hero-gradient .hero-slogan .highlight {
            color: #3B82F6;
            font-weight: 700;
        }

        .hero-gradient .hero-actions {
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        /* 진행률 섹션 */
        .hero-progress-section {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg);
            padding: 14px 24px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .hero-progress-dark {
            background: var(--bg);
        }

        .hero-progress-stats {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1e293b;
            font-size: 15px;
        }

        .hero-progress-label {
            color: #64748b;
            font-weight: 500;
        }

        .hero-progress-current {
            font-size: 28px;
            font-weight: 800;
            color: #3B82F6;
        }

        .hero-progress-arrow {
            color: #94a3b8;
            font-size: 18px;
        }

        .hero-progress-target {
            color: #475569;
            font-weight: 600;
        }

        .hero-progress-bar {
            width: 160px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .hero-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #06B6D4);
            border-radius: 5px;
            transition: width 0.5s ease;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        }

        .hero-progress-badge {
            background: linear-gradient(135deg, #3B82F6, #06B6D4);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .hero-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-gradient .period-select {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-weight: 500;
        }

        .hero-gradient .period-select option {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .hero-gradient .login-status {
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .hero-gradient .login-status-text {
            color: var(--text-primary);
        }

        .hero-gradient .theme-toggle {
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .hero-gradient .btn-secondary {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        /* 스탯 카드 */
        .hero-gradient .stats-grid {
            position: relative;
            z-index: 1;
            margin-top: 16px;
        }

        .stat-card-glass {
            background: var(--bg);
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card-glass:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .stat-card-glass .stat-value {
            color: var(--text-primary);
            font-size: 32px;
        }

        /* 다크모드 히어로 */
        [data-theme="dark"] .hero-gradient {
            background: var(--bg-elevated);
        }

        [data-theme="dark"] .stat-card-glass {
            background: var(--bg);
        }

        [data-theme="dark"] .stat-card-glass .stat-value {
            color: var(--text-primary);
        }

        .hero-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .hero-title-wrap {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hero-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .hero-meta-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hero-period-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 마지막 업데이트 표시 */
        .last-update {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .hero-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 기간 필터 */
        .period-filter {
            display: flex;
            gap: 8px;
            margin-right: 8px;
        }

        .period-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text-primary);
            cursor: pointer;
        }

        .presentation-mode .hero {
            padding: 48px;
        }

        .presentation-mode .hero-title {
            font-size: 32px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--blue-dark);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* 스탯 그리드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .stats-grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .stat-clickable {
            cursor: pointer;
        }

        .stat-clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .stat-deadline {
            color: #3B82F6 !important;
        }

        .stat-delayed {
            color: #191f28 !important;
        }

        .stat-card {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            background: var(--border-light);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
            line-height: 1;
        }

        /* 숫자 카운팅 애니메이션 */
        .stat-value.counting {
            transition: none;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--green);
        }

        .stat-change.down { color: var(--red); }

        /* ========== 콘텐츠 ========== */
        .content {
            padding: 32px 48px;
        }

        .content-compact {
            padding: 20px 48px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* 카드 */
        .card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* 차트 그리드 */
        .chart-grid {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .chart-area {
            height: 280px;
            position: relative;
        }

        /* 호버 툴팁 */
        .custom-tooltip {
            position: absolute;
            background: var(--text-primary);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }

        .custom-tooltip.show {
            opacity: 1;
        }

        .custom-tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .custom-tooltip-value {
            font-size: 18px;
            font-weight: 800;
        }

        /* 도넛 */
        .donut-layout {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .donut-wrap {
            position: relative;
            width: 160px;
            height: 160px;
            flex-shrink: 0;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-value {
            font-size: 40px;
            font-weight: 800;
            color: var(--blue);
            letter-spacing: -2px;
            line-height: 1;
        }

        .donut-label {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .donut-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .donut-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .donut-stat-row:hover {
            background: var(--blue-light);
        }

        .donut-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .donut-stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .donut-stat-value.green { color: var(--green); }
        .donut-stat-value.orange { color: var(--orange); }

        /* ========== 부서 그리드 ========== */
        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }

        /* 통합 도넛 차트 레이아웃 (Nakapin 스타일) */
        .section-compact {
            margin-bottom: 24px;
        }

        .section-compact .section-header {
            margin-bottom: 16px;
        }

        .dept-unified-donut {
            display: flex;
            flex-direction: column;
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 28px 36px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .dept-unified-header {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 28px;
        }

        .dept-unified-content {
            display: flex;
            align-items: center;
            gap: 48px;
        }

        .unified-donut-chart {
            position: relative;
            width: 180px;
            height: 180px;
            flex-shrink: 0;
        }

        .unified-donut-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .unified-donut-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 18;
        }

        .unified-donut-segment {
            fill: none;
            stroke-width: 18;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }

        .unified-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .unified-donut-pct {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .unified-donut-label {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .unified-donut-legend {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .legend-item:hover {
            background: var(--blue-light);
        }

        .legend-left {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 280px;
            flex-shrink: 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            min-width: 110px;
        }

        .legend-leader {
            font-size: 13px;
            color: #64748b;
            margin-left: 10px;
            white-space: nowrap;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .legend-center {
            flex: 1;
            padding: 0 24px;
            min-width: 150px;
        }

        .legend-progress-bar {
            height: 14px;
            background: #d1d5db;
            border-radius: 7px;
            overflow: hidden;
        }

        .legend-progress-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 0.8s ease;
        }

        .legend-right {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 150px;
            flex-shrink: 0;
            justify-content: flex-end;
        }

        .legend-pct {
            font-size: 20px;
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        .legend-kpi {
            font-size: 14px;
            color: #64748b;
            min-width: 80px;
            text-align: right;
        }

        /* 반응형 - 통합 도넛 */
        @media (max-width: 1200px) {
            .legend-left {
                width: 240px;
            }
        }
        
        @media (max-width: 900px) {
            .dept-unified-donut {
                padding: 24px;
            }
            .dept-unified-content {
                flex-direction: column;
                gap: 24px;
            }
            .unified-donut-chart {
                width: 160px;
                height: 160px;
            }
            .unified-donut-pct {
                font-size: 32px;
            }
            .legend-left {
                width: 200px;
            }
            .legend-center {
                flex: 1;
                padding: 0 12px;
                min-width: 100px;
            }
            .legend-progress-bar {
                height: 10px;
            }
            .legend-right {
                width: 110px;
            }
        }

        /* 부서별 도넛 그리드 - 새로운 스타일 */
        .dept-donut-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .dept-donut-card {
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .dept-donut-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
            border-color: var(--blue);
        }

        .dept-donut-wrap {
            position: relative;
            width: 100px;
            height: 100px;
            margin-bottom: 16px;
        }

        .dept-donut-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .dept-donut-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 8;
        }

        .dept-donut-progress {
            fill: none;
            stroke: var(--blue);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 1s ease-out;
        }

        .dept-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .dept-donut-pct {
            font-size: 22px;
            font-weight: 800;
            color: var(--blue);
            line-height: 1;
        }

        .dept-donut-info {
            width: 100%;
        }

        .dept-donut-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .dept-donut-leader {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .dept-donut-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .dept-donut-kpi-count {
            background: var(--blue-light);
            color: var(--blue);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .dept-donut-edit {
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 부서 색상 */
        .dept-donut-card[data-color="blue"] .dept-donut-progress { stroke: #3B82F6; }
        .dept-donut-card[data-color="blue"] .dept-donut-pct { color: #3B82F6; }
        .dept-donut-card[data-color="blue"] .dept-donut-kpi-count { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }

        .dept-donut-card[data-color="green"] .dept-donut-progress { stroke: #10B981; }
        .dept-donut-card[data-color="green"] .dept-donut-pct { color: #10B981; }
        .dept-donut-card[data-color="green"] .dept-donut-kpi-count { background: rgba(16, 185, 129, 0.1); color: #10B981; }

        .dept-donut-card[data-color="purple"] .dept-donut-progress { stroke: #8B5CF6; }
        .dept-donut-card[data-color="purple"] .dept-donut-pct { color: #8B5CF6; }
        .dept-donut-card[data-color="purple"] .dept-donut-kpi-count { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }

        .dept-donut-card[data-color="orange"] .dept-donut-progress { stroke: #F59E0B; }
        .dept-donut-card[data-color="orange"] .dept-donut-pct { color: #F59E0B; }
        .dept-donut-card[data-color="orange"] .dept-donut-kpi-count { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }

        .dept-donut-card[data-color="cyan"] .dept-donut-progress { stroke: #06B6D4; }
        .dept-donut-card[data-color="cyan"] .dept-donut-pct { color: #06B6D4; }
        .dept-donut-card[data-color="cyan"] .dept-donut-kpi-count { background: rgba(6, 182, 212, 0.1); color: #06B6D4; }

        .dept-donut-card[data-color="pink"] .dept-donut-progress { stroke: #EC4899; }
        .dept-donut-card[data-color="pink"] .dept-donut-pct { color: #EC4899; }
        .dept-donut-card[data-color="pink"] .dept-donut-kpi-count { background: rgba(236, 72, 153, 0.1); color: #EC4899; }

        .dept-donut-card[data-color="indigo"] .dept-donut-progress { stroke: #6366F1; }
        .dept-donut-card[data-color="indigo"] .dept-donut-pct { color: #6366F1; }
        .dept-donut-card[data-color="indigo"] .dept-donut-kpi-count { background: rgba(99, 102, 241, 0.1); color: #6366F1; }

        /* 반응형 - 도넛 그리드 */
        @media (max-width: 1400px) {
            .dept-donut-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .dept-donut-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .dept-donut-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .dept-donut-card {
                padding: 16px;
            }
            .dept-donut-wrap {
                width: 80px;
                height: 80px;
            }
            .dept-donut-pct {
                font-size: 18px;
            }
            .dept-donut-name {
                font-size: 13px;
            }
        }

        .dept-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .dept-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--blue);
        }

        /* 부서 카드 - toss 스타일 */
        .dept-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-light);
        }

        .dept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .dept-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .dept-leader {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* 수정자 표시 */
        .dept-updated-by {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dept-pct {
            font-size: 28px;
            font-weight: 800;
            color: var(--blue);
        }

        .dept-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .dept-bar-fill {
            height: 100%;
            background: var(--blue);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
        }

        /* 프로그레스 바 애니메이션 */
        .dept-bar-fill.animated {
            animation: progressGrow 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes progressGrow {
            from { width: 0; }
        }

        .dept-meta {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* ========== 성과자 ========== */
        .winners-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .winner-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .winner-card:hover {
            box-shadow: var(--shadow-md);
        }

        .winner-card.gold { border-top: 3px solid #FFB800; }
        .winner-card.silver { border-top: 3px solid #8B95A1; }
        .winner-card.bronze { border-top: 3px solid #CD7F32; }

        .winner-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            color: white;
            margin: 0 auto 20px;
        }

        .winner-card.gold .winner-rank { background: linear-gradient(135deg, #FFB800, #FFD54F); }
        .winner-card.silver .winner-rank { background: linear-gradient(135deg, #8B95A1, #B0B8C1); }
        .winner-card.bronze .winner-rank { background: linear-gradient(135deg, #CD7F32, #DDA15E); }

        .winner-avatar {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            background: var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 800;
            color: white;
            margin: 0 auto 16px;
        }

        .winner-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .winner-dept {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .winner-score {
            font-size: 32px;
            font-weight: 800;
            color: var(--blue);
        }

        .winner-score-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* ========== 상세 페이지 ========== */
        .page { display: none; }
        .page.active { display: block; }

        .detail-hero {
            background: var(--bg-elevated);
            padding: 32px 48px;
            border-bottom: 1px solid var(--border);
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .back-btn:hover {
            background: var(--border-light);
        }

        .detail-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .detail-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .detail-stats {
            margin-left: auto;
            display: flex;
            gap: 40px;
        }

        .detail-stat { text-align: center; }

        .detail-stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--blue);
        }

        .detail-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .detail-content {
            padding: 32px 48px;
        }

        /* 탭 */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: var(--bg);
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .tab:hover {
            background: var(--border-light);
        }

        .tab.active {
            background: var(--blue);
            color: white;
        }

        /* 팀별 진척률 바 */
        .team-progress-bar {
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--bg) 100%);
            border: 1px solid var(--blue);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            margin-bottom: 20px;
        }

        .team-progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .team-progress-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--blue);
        }

        .team-progress-value,
        .team-progress-members {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .team-progress-value strong,
        .team-progress-members strong {
            color: var(--text-primary);
            font-weight: 700;
        }

        .team-progress-kpi {
            font-size: 13px;
            color: var(--text-tertiary);
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 12px;
        }

        /* 멤버 그리드 */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 28px;
        }

        .member-card {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .member-card:hover {
            background: var(--blue-light);
        }

        .member-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: white;
        }

        .member-info { flex: 1; }
        .member-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .member-role { font-size: 13px; color: var(--text-tertiary); }
        .member-right { text-align: right; }
        .member-pct { font-size: 20px; font-weight: 800; color: var(--blue); }
        .member-cnt { font-size: 12px; color: var(--text-tertiary); }

        /* 업무 */
        .task-section { margin-top: 24px; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .btn-add {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            background: var(--blue);
            color: white;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-add:hover {
            background: var(--blue-dark);
        }

        .task-form {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            display: none;
        }

        .task-form.show { display: block; }

        .task-form-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input {
            flex: 2;
            min-width: 180px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
            transition: border-color 0.15s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .select {
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* 담당자 체크박스 컨테이너 */
        .assignee-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            min-height: 44px;
        }

        .assignee-checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 13px;
        }

        .assignee-checkbox-item:hover {
            border-color: var(--blue);
            background: var(--blue-light);
        }

        .assignee-checkbox-item.selected {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .assignee-checkbox-item input[type="checkbox"] {
            display: none;
        }

        /* 툴팁 아이콘 */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 12px;
            color: var(--text-tertiary);
            cursor: help;
            position: relative;
        }

        .tooltip-icon:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--text-primary);
            color: var(--bg-elevated);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 4px;
        }

        /* ========== 로그인 페이지 (전체 화면) ========== */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e8f4ff 100%);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .login-page.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-container {
            width: 100%;
            max-width: 520px;
            padding: 20px;
        }

        .login-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 48px 56px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .login-logo-img {
            height: 40px;
            width: auto;
        }

        .login-logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 15px;
            color: var(--text-tertiary);
        }

        .login-form-group {
            margin-bottom: 24px;
        }

        .login-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-select {
            width: 100%;
            padding: 16px 18px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-select:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--blue-light);
        }

        .pin-input-container {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .pin-input {
            width: 64px;
            height: 72px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            background: var(--bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--blue-light);
        }

        .pin-input.filled {
            border-color: var(--blue);
            background: var(--blue-light);
        }

        .pin-input.error {
            border-color: var(--red);
            background: var(--red-light);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }

        .login-error {
            text-align: center;
            color: var(--red);
            font-size: 13px;
            margin-top: 12px;
            min-height: 20px;
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .login-btn:hover {
            background: var(--blue-dark);
            transform: translateY(-1px);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 28px 0;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .login-guest-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            color: var(--text-secondary);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-guest-btn:hover {
            background: var(--bg);
            border-color: var(--text-tertiary);
        }

        .login-footer {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-light);
        }

        .login-footer-text {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* 로그인 상태 표시 (헤더) */
        .login-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-status:hover {
            background: var(--border-light);
        }

        .login-status.logged-in {
            background: var(--blue-light);
            color: var(--blue);
        }

        .login-status-icon {
            font-size: 16px;
        }

        .login-status-text {
            font-weight: 500;
        }

        .login-status-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            line-height: 1;
        }

        .login-status-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        /* 다크모드 로그인 페이지 */
        [data-theme="dark"] .login-page {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
        }

        /* 사이드바 하단 로그인 정보 */
        .sidebar-user-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: rgba(255,255,255,0.05);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: #3B82F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .sidebar-user-details {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-size: 14px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-role {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        .sidebar-logout-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .sidebar-logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            position: relative;
        }

        /* 우선순위 바 */
        .priority-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 4px 0 0 4px;
        }

        .priority-bar.high { background: var(--red); }
        .priority-bar.medium { background: var(--orange); }
        .priority-bar.low { background: var(--green); }

        .task-item.has-priority {
            padding-left: 24px;
        }

        .task-name {
            flex: 2;
            min-width: 140px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .task-name input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--blue);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
            display: none;
        }

        .task-name input.show { display: block; }
        .task-name span.hide { display: none; }

        /* D-day 표시 */
        .task-dday {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .task-dday.overdue {
            background: var(--red-light);
            color: var(--red);
        }

        .task-dday.urgent {
            background: var(--orange-light);
            color: var(--orange);
        }

        .task-dday.normal {
            background: var(--blue-light);
            color: var(--blue);
        }

        .task-dday.done {
            background: var(--green-light);
            color: var(--green);
        }

        /* 수정자 표시 */
        .task-updated-by {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .task-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
        }

        .task-actions {
            display: flex;
            gap: 6px;
        }

        .btn-xs {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-edit { background: var(--blue-light); color: var(--blue); }
        .btn-del { background: var(--red-light); color: var(--red); }
        .btn-history { background: var(--orange-light); color: var(--orange); }
        .btn-edit:hover { background: #d0e4ff; }
        .btn-del:hover { background: #ffd6d9; }
        .btn-history:hover { background: #ffe4c4; }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-tertiary);
        }

        .empty-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* 모달 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal.show { opacity: 1; pointer-events: auto; }

        .modal-box {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 440px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .modal.show .modal-box { transform: scale(1); }

        .modal-header {
            padding: 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-avatar {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: white;
        }

        .modal-name { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .modal-dept { font-size: 14px; color: var(--text-tertiary); }

        .modal-close {
            margin-left: auto;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg);
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: background 0.15s ease;
        }

        .modal-close:hover { background: var(--border-light); }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: var(--bg);
            padding: 24px;
        }

        .modal-stat { text-align: center; }
        .modal-stat-value { font-size: 24px; font-weight: 800; color: var(--blue); }
        .modal-stat-label { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }

        .modal-body {
            padding: 20px 24px 28px;
            max-height: 280px;
            overflow-y: auto;
        }

        .modal-task {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .modal-task-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .modal-task-sub { font-size: 12px; color: var(--text-tertiary); }
        .modal-task-pct { font-size: 18px; font-weight: 800; color: var(--blue); }

        /* 변경 이력 모달 */
        .history-modal .modal-box {
            max-width: 560px;
        }

        .history-modal .modal-header {
            background: var(--blue-light);
        }

        .history-item {
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-action {
            font-size: 13px;
            font-weight: 600;
            color: var(--blue);
        }

        .history-date {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .history-detail {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .history-by {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        /* 통계 모달 */
        .stat-modal .modal-box {
            max-width: 700px;
            max-height: 80vh;
        }

        .stat-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .stat-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .stat-modal-body {
            padding: 20px 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .stat-team-section {
            margin-bottom: 12px;
        }

        .stat-team-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: var(--blue-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-team-header:hover {
            background: #dbeafe;
        }

        .stat-team-header .arrow {
            margin-left: auto;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
        }

        .stat-team-header.open .arrow {
            transform: rotate(180deg);
        }

        .stat-team-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .stat-team-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-team-count {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .stat-team-content {
            display: none;
            padding: 8px 0;
        }

        .stat-team-content.open {
            display: block;
        }

        /* 서브팀 (팀별) 아코디언 */
        .stat-subteam-section {
            margin-bottom: 6px;
            margin-left: 12px;
        }

        .stat-subteam-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-subteam-header:hover {
            background: var(--border-light);
        }

        .stat-subteam-header .arrow {
            margin-left: auto;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .stat-subteam-header.open .arrow {
            transform: rotate(180deg);
        }

        .stat-subteam-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-subteam-count {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .stat-subteam-content {
            display: none;
            padding: 6px 0 6px 12px;
        }

        .stat-subteam-content.open {
            display: block;
        }

        .stat-kpi-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-kpi-item:hover {
            background: var(--border-light);
        }

        .stat-kpi-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .stat-kpi-progress {
            font-size: 16px;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .stat-kpi-progress.delayed {
            color: #EF4444;
        }

        .stat-kpi-progress.done {
            color: #10B981;
        }

        .stat-member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .stat-member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--blue-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--blue);
        }

        .stat-member-info {
            flex: 1;
        }

        .stat-member-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-member-role {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .stat-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .stat-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* 토스트 */
        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--text-primary);
            color: white;
            padding: 16px 28px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* 반응형 */
        @media (max-width: 1200px) {
            .chart-grid { grid-template-columns: 1fr; }
            .winners-grid { grid-template-columns: 1fr; }
            .goal-banner { flex-wrap: wrap; gap: 16px; }
            .goal-progress-bar { order: 3; max-width: 100%; flex-basis: 100%; margin: 0; }
        }

        @media (max-width: 1200px) {
            .stats-grid-5 { grid-template-columns: repeat(5, 1fr); gap: 12px; }
            .stat-card { padding: 16px 12px; }
            .stat-value { font-size: 28px; }
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .hero { padding: 24px; }
            .content { padding: 24px; }
            .detail-hero { padding: 24px; }
            .detail-content { padding: 24px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid-5 { grid-template-columns: repeat(3, 1fr); }
            .goal-banner { padding: 16px 24px; }
        }

        /* ========== 모바일 최적화 (600px 이하) ========== */
        @media (max-width: 600px) {
            /* 새 히어로 그라데이션 모바일 */
            .hero-gradient {
                padding: 20px 16px;
                border-radius: 0 0 16px 16px;
            }

            .hero-gradient .hero-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .hero-gradient .hero-title {
                font-size: 20px;
            }

            .hero-gradient .hero-slogan {
                font-size: 13px;
            }

            .hero-gradient .hero-actions {
                width: 100%;
                align-items: stretch;
            }

            .hero-progress-section {
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
                padding: 10px 16px;
            }

            .hero-progress-stats {
                font-size: 13px;
            }

            .hero-progress-current {
                font-size: 18px;
            }

            .hero-progress-bar {
                width: 100px;
            }

            .hero-progress-badge {
                font-size: 12px;
                padding: 5px 10px;
            }

            .hero-controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .hero-controls .period-filter {
                width: 100%;
                margin-right: 0;
            }

            /* 상단 슬로건 배너 (기존) */
            .top-slogan-bar {
                padding: 24px 16px;
            }
            
            .slogan-company {
                font-size: 12px;
                padding: 6px 12px;
                letter-spacing: 1px;
            }
            
            .slogan-main {
                font-size: 20px;
                margin-bottom: 16px;
                line-height: 1.4;
            }
            
            .slogan-progress-wrap {
                flex-direction: column;
                gap: 12px;
            }
            
            .slogan-stats {
                font-size: 13px;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .slogan-current {
                font-size: 18px !important;
            }
            
            .slogan-progress-bar {
                width: 160px;
            }
            
            .slogan-achievement {
                font-size: 12px;
                padding: 6px 12px;
            }

            /* 히어로 영역 */
            .hero {
                padding: 16px;
            }
            
            .hero-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .hero-title {
                font-size: 22px;
            }
            
            .hero-meta-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .hero-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .period-filter {
                width: 100%;
                margin-right: 0;
                margin-bottom: 8px;
            }
            
            .period-select {
                flex: 1;
                min-width: 0;
                padding: 10px 8px;
                font-size: 12px;
            }
            
            /* 로그인 상태 */
            .login-status {
                padding: 8px 12px !important;
            }
            
            .login-status-text {
                font-size: 12px;
            }

            /* 통계 그리드 */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stats-grid-5 {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid-5 .stat-card:first-child {
                grid-column: 1 / -1;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 11px;
            }

            /* 콘텐츠 영역 */
            .content {
                padding: 16px;
            }

            .content-compact {
                padding: 16px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .section-title {
                font-size: 16px;
            }

            /* 부서 카드 그리드 */
            .dept-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .dept-card {
                padding: 16px;
            }
            
            .dept-name {
                font-size: 15px;
            }
            
            .dept-pct {
                font-size: 24px;
            }

            /* 부서별 현황 통합 (모바일) */
            .dept-unified-donut {
                padding: 20px 16px;
            }

            .dept-unified-header {
                font-size: 18px;
                margin-bottom: 16px;
            }

            .dept-unified-content {
                flex-direction: column;
                align-items: center;
                gap: 24px;
            }

            .unified-donut-chart {
                width: 140px;
                height: 140px;
            }

            .unified-donut-bg,
            .unified-donut-segment {
                stroke-width: 14;
            }

            .unified-donut-pct {
                font-size: 32px;
            }

            .unified-donut-label {
                font-size: 12px;
            }

            .unified-donut-legend {
                width: 100%;
                gap: 8px;
            }

            .legend-item {
                padding: 12px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .legend-left {
                width: 100%;
                gap: 8px;
            }

            .legend-color {
                width: 8px;
                height: 8px;
            }

            .legend-name {
                font-size: 14px;
            }

            .legend-leader {
                font-size: 12px;
            }

            .legend-center {
                display: none;
            }

            .legend-right {
                width: 100%;
                justify-content: flex-end;
                gap: 12px;
            }

            .legend-pct {
                font-size: 16px;
                min-width: 40px;
            }

            .legend-kpi {
                font-size: 12px;
                min-width: auto;
            }

            /* 차트 그리드 */
            .chart-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .card {
                padding: 16px;
            }
            
            .card-title {
                font-size: 14px;
                margin-bottom: 16px;
            }
            
            .chart-area {
                height: 200px;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .chart-area canvas {
                min-width: 300px;
            }
            
            /* 도넛 차트 레이아웃 */
            .donut-layout {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .donut-wrap {
                width: 140px;
                height: 140px;
            }
            
            .donut-value {
                font-size: 32px;
            }
            
            .donut-label {
                font-size: 12px;
            }
            
            .donut-stats {
                width: 100%;
            }
            
            .donut-stat-row {
                padding: 12px 14px;
            }
            
            .donut-stat-label {
                font-size: 13px;
            }
            
            .donut-stat-value {
                font-size: 18px;
            }

            /* 상세 페이지 */
            .detail-hero {
                padding: 16px;
            }
            
            .detail-title {
                font-size: 22px;
            }
            
            .detail-content {
                padding: 16px;
            }

            /* 탭 */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
                margin-bottom: 16px;
                gap: 8px;
            }
            
            .tab {
                flex-shrink: 0;
                padding: 10px 16px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* 팀 진척률 바 */
            .team-progress-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 16px;
            }
            
            .team-progress-bar .team-name {
                font-size: 14px;
            }

            /* KPI 섹션 */
            .kpi-section {
                padding: 16px;
            }
            
            .kpi-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .kpi-header-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .kpi-mission {
                padding: 16px;
            }
            
            .kpi-mission-text {
                font-size: 14px;
            }
            
            .kpi-metrics-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .kpi-metric-card {
                padding: 16px;
            }
            
            .kpi-metric-progress {
                font-size: 24px;
            }
            
            .kpi-metric-value {
                font-size: 22px;
            }
            
            .kpi-team-progress {
                font-size: 14px;
                padding: 12px;
            }
            
            .kpi-conditions {
                padding: 16px;
            }
            
            .kpi-condition-text {
                font-size: 13px;
            }

            /* Initiative / 핵심 과제 */
            .initiative-section {
                padding: 16px;
            }
            
            .initiative-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .initiative-stats {
                width: 100%;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .initiative-stat {
                padding: 12px 8px;
            }
            
            .initiative-stat-value {
                font-size: 20px;
            }
            
            .initiative-stat-label {
                font-size: 11px;
            }
            
            .initiative-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 16px;
            }
            
            .init-info {
                width: 100%;
            }
            
            .init-name {
                font-size: 14px;
            }
            
            .init-meta {
                font-size: 12px;
            }
            
            .init-assignee {
                font-size: 13px;
            }
            
            .init-operation {
                font-size: 12px;
            }
            
            .init-progress {
                width: 100%;
            }
            
            .init-progress-bar {
                flex: 1;
            }
            
            .init-actions {
                width: 100%;
                justify-content: flex-end;
                opacity: 1;
            }

            /* 멤버 그리드 */
            .member-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .member-card {
                padding: 14px;
            }

            /* 모달 */
            .modal-box {
                width: 95%;
                max-width: none;
                margin: 16px;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 16px;
            }
            
            .modal-body {
                padding: 16px;
                max-height: 60vh;
            }
            
            .modal-stats {
                padding: 16px;
            }
            
            .modal-stat-value {
                font-size: 20px;
            }

            /* KPI 모달 */
            .kpi-modal .modal-box {
                width: 95%;
                max-height: 85vh;
            }

            /* 통계 모달 모바일 */
            .stat-modal .modal-box {
                width: 95%;
                max-width: none;
                margin: 16px;
            }

            .stat-modal-header {
                padding: 16px;
            }

            .stat-modal-title {
                font-size: 18px;
            }

            .stat-modal-body {
                padding: 16px;
                max-height: 65vh;
            }

            .stat-team-header {
                padding: 12px 14px;
            }

            .stat-team-name {
                font-size: 14px;
            }

            .stat-team-count {
                font-size: 13px;
            }

            .stat-subteam-section {
                margin-left: 8px;
            }

            .stat-subteam-header {
                padding: 10px 12px;
            }

            .stat-subteam-name {
                font-size: 13px;
            }

            .stat-kpi-item {
                padding: 10px 12px;
            }

            .stat-kpi-name {
                font-size: 13px;
            }

            .stat-kpi-progress {
                font-size: 14px;
                min-width: 50px;
            }

            .stat-member-item {
                padding: 10px 12px;
            }

            .stat-member-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .stat-member-name {
                font-size: 13px;
            }

            .stat-member-role {
                font-size: 11px;
            }
            
            .kpi-form-section {
                padding: 12px;
            }
            
            .kpi-modal-footer {
                padding: 12px 16px;
            }
            
            .metric-field-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            /* Initiative 모달 */
            #initiativeModal .modal-box {
                width: 95%;
                padding: 16px;
            }

            /* 버튼 */
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .btn-icon {
                width: 36px;
                height: 36px;
            }

            /* 토스트 */
            .toast {
                left: 16px;
                right: 16px;
                transform: translateY(80px);
                width: auto;
            }
            
            .toast.show {
                transform: translateY(0);
            }

            /* 자동 새로고침 표시 */
            .auto-refresh-indicator {
                bottom: 16px;
                right: 16px;
                font-size: 11px;
                padding: 6px 12px;
            }
        }

        /* ========== 아주 작은 화면 (400px 이하) ========== */
        @media (max-width: 400px) {
            .top-slogan-bar {
                padding: 20px 12px;
            }
            
            .slogan-main {
                font-size: 18px;
            }
            
            .hero {
                padding: 12px;
            }
            
            .hero-title {
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            /* 차트 */
            .card {
                padding: 12px;
            }
            
            .chart-area {
                height: 180px;
            }
            
            .donut-wrap {
                width: 120px;
                height: 120px;
            }
            
            .donut-value {
                font-size: 28px;
            }
            
            .donut-stat-row {
                padding: 10px 12px;
            }
            
            .donut-stat-value {
                font-size: 16px;
            }
            
            .initiative-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .period-filter {
                flex-wrap: wrap;
            }
            
            .period-select {
                flex: 1 1 45%;
            }
        }

        /* 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate { animation: fadeIn 0.4s ease forwards; }

        /* 다크모드 토글 */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--border-light);
        }

        [data-theme="dark"] .theme-toggle {
            background: var(--bg-elevated);
        }

        .theme-icon-light,
        .theme-icon-dark {
            display: none;
        }

        :root .theme-icon-light { display: block; }
        :root .theme-icon-dark { display: none; }
        [data-theme="dark"] .theme-icon-light { display: none; }
        [data-theme="dark"] .theme-icon-dark { display: block; }

        /* ========== 회사 슬로건 배너 (숨김 - top-slogan-bar로 대체) ========== */
        .slogan-banner {
            display: none;
        }

        /* ========== KPI 섹션 ========== */
        .kpi-section {
            margin-top: 24px;
        }

        .kpi-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .kpi-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* KPI 미션 카드 */
        .kpi-mission {
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--bg) 100%);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
            border-left: 4px solid var(--blue);
        }

        .kpi-mission-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-mission-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.7;
        }

        /* KPI 지표 그리드 */
        .kpi-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .kpi-metric-card {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .kpi-metric-card.main {
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--bg) 100%);
            border: 1px solid var(--blue);
        }

        .kpi-metric-card:hover {
            background: var(--blue-light);
            transform: translateY(-2px);
        }

        .kpi-metric-progress {
            font-size: 32px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .kpi-metric-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--blue);
            line-height: 1;
        }

        .kpi-metric-unit {
            font-size: 14px;
            font-weight: 600;
            color: var(--blue);
        }

        .kpi-metric-label {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }

        .kpi-metric-detail {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .kpi-metric-period {
            font-size: 11px;
            color: var(--text-disabled);
            margin-top: 4px;
        }

        .kpi-team-progress {
            text-align: center;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius-md);
            margin-top: 12px;
            font-size: 15px;
            color: var(--text-secondary);
        }

        .kpi-team-progress strong {
            color: var(--blue);
            font-size: 18px;
        }

        /* 서브 KPI 스타일 */
        .kpi-sub-section {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .kpi-sub-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .kpi-sub-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 24px;
        }

        .kpi-sub-item {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .kpi-sub-item strong {
            color: var(--text-primary);
        }

        /* KPI 조건 리스트 */
        .kpi-conditions {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .kpi-conditions-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .kpi-condition-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .kpi-condition-item:last-child {
            border-bottom: none;
        }

        .kpi-condition-bullet {
            width: 6px;
            height: 6px;
            background: var(--blue);
            border-radius: 50%;
            margin-top: 7px;
            flex-shrink: 0;
        }

        .kpi-condition-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* KPI 빈 상태 */
        .kpi-empty {
            text-align: center;
            padding: 48px 20px;
        }

        .kpi-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .kpi-empty-text {
            font-size: 15px;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .btn-kpi-add {
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            background: var(--blue);
            color: white;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-kpi-add:hover {
            background: var(--blue-dark);
        }

        /* KPI 수정 모달 */
        .kpi-modal .modal-box {
            max-width: 640px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .kpi-modal .modal-header {
            flex-shrink: 0;
        }

        .kpi-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            padding: 24px;
        }

        .kpi-form-section {
            margin-bottom: 24px;
        }

        .kpi-form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-form-label .required {
            color: var(--red);
            font-size: 12px;
        }

        .kpi-form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text-primary);
            resize: vertical;
            transition: border-color 0.15s ease;
        }

        .kpi-form-textarea:focus {
            outline: none;
            border-color: var(--blue);
        }

        .kpi-form-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-bottom: 12px;
        }

        .kpi-form-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--blue);
        }

        .kpi-form-toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .kpi-form-toggle-desc {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .kpi-form-items {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .kpi-form-items.show {
            display: flex;
        }

        .kpi-form-item {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .kpi-form-item.sub {
            background: var(--bg-elevated);
        }

        .kpi-form-item input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .kpi-form-item input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .kpi-form-item input.small {
            max-width: 80px;
        }

        .target-input {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--blue-light);
            padding: 4px 8px 4px 12px;
            border-radius: 8px;
        }

        .target-prefix {
            font-size: 12px;
            font-weight: 600;
            color: var(--blue);
            white-space: nowrap;
        }

        .target-input input {
            max-width: 70px;
            background: white;
        }

        .btn-remove-item {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--red-light);
            color: var(--red);
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-add-item {
            padding: 10px 16px;
            border-radius: 8px;
            background: var(--blue-light);
            color: var(--blue);
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-form-condition {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .kpi-form-condition textarea {
            flex: 1;
            min-height: 60px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text-primary);
            resize: vertical;
        }

        .kpi-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-shrink: 0;
        }

        /* Initiative 목록 스타일 */
        .initiative-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 8px;
            gap: 16px;
            transition: all 0.2s;
        }
        .initiative-item:hover {
            background: var(--border-light);
        }
        .init-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .init-status.operating { background: var(--green); }
        .init-status.preparing { background: var(--orange); }
        .init-status.not-started { background: var(--text-disabled); }
        .init-info {
            flex: 1;
            min-width: 0;
        }
        .init-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .init-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 12px;
        }
        .init-assignee {
            min-width: 120px;
            max-width: 180px;
            text-align: right;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            word-break: keep-all;
        }
        .init-operation {
            width: 70px;
            text-align: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .init-operation.operating {
            background: var(--green-light);
            color: var(--green);
        }
        .init-operation.preparing {
            background: var(--orange-light);
            color: var(--orange);
        }
        .init-operation.not-started {
            background: var(--border-light);
            color: var(--text-tertiary);
        }
        .init-progress {
            width: 120px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .init-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .init-progress-fill {
            height: 100%;
            background: var(--blue);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .init-progress-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            width: 35px;
            text-align: right;
        }
        .init-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .initiative-item:hover .init-actions {
            opacity: 1;
        }
        .init-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .init-action-btn.edit {
            background: var(--blue-light);
            color: var(--blue);
        }
        .init-action-btn.edit:hover {
            background: var(--blue);
            color: white;
        }
        .init-action-btn.delete {
            background: var(--red-light);
            color: var(--red);
        }
        .init-action-btn.delete:hover {
            background: var(--red);
            color: white;
        }

        /* Initiative 모달 */
        #initiativeModal .modal-box {
            padding: 24px;
        }
        #initiativeModal .input,
        #initiativeModal .select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        #initiativeModal .input:focus,
        #initiativeModal .select:focus {
            outline: none;
            border-color: var(--blue);
        }

        /* 자동 새로고침 표시 */
        .auto-refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-tertiary);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        .refresh-dot {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/netformrnd-lab/netform-kpi-dashboard-BS/main/logo.jpg" alt="Netform R&D" class="logo-img">
                <div class="logo-text">
                    넷폼알앤디
                    <span>KPI Dashboard</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-label">메인</div>
                <div class="nav-item active" onclick="goMain()">대시보드</div>
            </div>

            <div class="nav-section">
                <div class="nav-label">부서</div>
                <div id="navDepts"></div>
            </div>

            <!-- 사이드바 하단 로그인 정보 -->
            <div class="sidebar-user-info" id="sidebarUserInfo" style="display: none;">
                <div class="sidebar-user-avatar">👤</div>
                <div class="sidebar-user-details">
                    <div class="sidebar-user-name" id="sidebarUserName">-</div>
                    <div class="sidebar-user-role">로그인 중</div>
                </div>
                <button class="sidebar-logout-btn" onclick="logout()" title="로그아웃">🚪</button>
            </div>
        </aside>

        <!-- 메인 -->
        <main class="main">
            <!-- 메인 페이지 -->
            <div class="page active" id="mainPage">
                <!-- 전사 KPI 대시보드 (새 디자인) -->
                <div class="hero hero-gradient">
                    <div class="hero-top">
                        <div class="hero-title-wrap">
                            <h1 class="hero-title">전사 KPI 대시보드</h1>
                            <div class="hero-slogan">"본질을 <span class="highlight">측정 & 관리</span>하며 2배 성장"</div>
                        </div>
                        <div class="hero-actions">
                            <div class="hero-progress-section hero-progress-dark">
                                <div class="hero-progress-stats">
                                    <span class="hero-progress-label">현재</span>
                                    <span class="hero-progress-current" id="topCurrentPct">4%</span>
                                    <span class="hero-progress-arrow">→</span>
                                    <span class="hero-progress-target">목표 100%</span>
                                </div>
                                <div class="hero-progress-bar">
                                    <div class="hero-progress-fill" id="topProgressFill" style="width: 4%"></div>
                                </div>
                                <span class="hero-progress-badge" id="topProgressText">4.0% 달성</span>
                            </div>
                            <div class="hero-controls">
                                <div class="login-status" id="loginStatus" onclick="openLoginModal()">
                                    <span class="login-status-icon">🔐</span>
                                    <span class="login-status-text">로그인</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid stats-grid-5">
                        <div class="stat-card stat-card-glass">
                            <div class="stat-label">마감일</div>
                            <div class="stat-value stat-deadline" id="statDeadline">D-336</div>
                        </div>
                        <div class="stat-card stat-card-glass stat-clickable" onclick="openStatModal('delayed')">
                            <div class="stat-label">지연 KPI</div>
                            <div class="stat-value stat-delayed" id="statDelayed">0</div>
                        </div>
                        <div class="stat-card stat-card-glass stat-clickable" onclick="openStatModal('done')">
                            <div class="stat-label">활성화 KPI</div>
                            <div class="stat-value" id="statDone">0</div>
                        </div>
                        <div class="stat-card stat-card-glass stat-clickable" onclick="openStatModal('total')">
                            <div class="stat-label">전체 메인 KPI</div>
                            <div class="stat-value" id="statTotal">0</div>
                        </div>
                        <div class="stat-card stat-card-glass stat-clickable" onclick="openStatModal('members')">
                            <div class="stat-label">참여 인원</div>
                            <div class="stat-value" id="statMembers">0</div>
                        </div>
                    </div>
                </div>

                <div class="content content-compact">
                    <!-- 부서별 현황 -->
                    <div class="dept-unified-donut" id="deptGrid"></div>
                </div>
            </div>

            <!-- 상세 페이지 -->
            <div class="page" id="detailPage">
                <div class="detail-hero">
                    <div class="detail-header">
                        <button class="back-btn" onclick="goMain()">←</button>
                        <div>
                            <h1 class="detail-title" id="detailTitle">부서명</h1>
                            <p class="detail-subtitle" id="detailSubtitle">리더</p>
                        </div>
                        <div class="detail-stats">
                            <div class="detail-stat">
                                <div class="detail-stat-value" id="detailProgress">0%</div>
                                <div class="detail-stat-label">진척률</div>
                            </div>
                            <div class="detail-stat">
                                <div class="detail-stat-value" id="detailMembers">0</div>
                                <div class="detail-stat-label">인원</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-content">
                    <div class="tabs" id="tabs"></div>

                    <!-- 선택된 팀 진척률 표시 -->
                    <div class="team-progress-bar" id="teamProgressBar">
                        <div class="team-progress-info">
                            <span class="team-progress-name" id="teamProgressName">그로스팀</span>
                            <span class="team-progress-value">진척률 <strong id="teamProgressValue">0%</strong></span>
                            <span class="team-progress-members">인원 <strong id="teamProgressMembers">0</strong>명</span>
                            <span class="team-progress-kpi" id="teamProgressKpi">메인 KPI 0개</span>
                        </div>
                    </div>

                    <!-- KPI 섹션 -->
                    <div class="kpi-section">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-title">팀 KPI</div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <a href="#" id="kpiDetailLink" target="_blank" class="btn btn-primary" style="display:none; text-decoration:none; font-size:13px;">
                                        상세 보기 🔗
                                    </a>
                                    <button class="btn btn-secondary" onclick="openKpiModal()" id="kpiEditBtn" style="display:none">수정</button>
                                </div>
                            </div>
                            <div id="kpiContent"></div>
                        </div>
                    </div>

                    <!-- 핵심 과제 / Initiative 목록 (팀별 동적) -->
                    <div class="initiative-section" id="initiativeSection" style="margin-top: 24px;">
                        <div class="card">
                            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                <div class="card-title" style="margin:0;" id="initSectionTitle">🎯 핵심 과제 현황</div>
                                <button class="btn btn-primary" onclick="openInitiativeModal()" style="font-size:13px;" id="initAddBtn">
                                    + 핵심 과제 추가
                                </button>
                            </div>
                            <div class="initiative-stats" style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px;">
                                <div class="init-stat-card" style="background:var(--blue-light); padding:16px; border-radius:12px; text-align:center;">
                                    <div style="font-size:24px; font-weight:700; color:var(--blue);" id="initInProgress">0</div>
                                    <div style="font-size:13px; color:var(--text-secondary);">진행 중</div>
                                </div>
                                <div class="init-stat-card" style="background:var(--green-light); padding:16px; border-radius:12px; text-align:center;">
                                    <div style="font-size:24px; font-weight:700; color:var(--green);" id="initCompleted">0</div>
                                    <div style="font-size:13px; color:var(--text-secondary);">완료</div>
                                </div>
                                <div class="init-stat-card" style="background:var(--orange-light); padding:16px; border-radius:12px; text-align:center;">
                                    <div style="font-size:24px; font-weight:700; color:var(--orange);" id="initOperating">0</div>
                                    <div style="font-size:13px; color:var(--text-secondary);">운영 중</div>
                                </div>
                                <div class="init-stat-card" style="background:var(--border-light); padding:16px; border-radius:12px; text-align:center;">
                                    <div style="font-size:24px; font-weight:700; color:var(--text-primary);" id="initRate">0%</div>
                                    <div style="font-size:13px; color:var(--text-secondary);">완료율</div>
                                </div>
                            </div>
                            <div class="initiative-list" id="initiativeList"></div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- 프레젠테이션 모드 표시 -->
    <div class="presentation-indicator">프레젠테이션 모드 (ESC로 종료)</div>

    <!-- 핵심 과제 / Initiative 추가/수정 모달 -->
    <div class="modal" id="initiativeModal">
        <div class="modal-box" style="max-width:500px;">
            <div class="modal-header" style="border-bottom:1px solid var(--border-light); padding-bottom:16px;">
                <div style="font-size:18px; font-weight:700;" id="initModalTitle">핵심 과제 추가</div>
                <button class="modal-close" onclick="closeInitiativeModal()">✕</button>
            </div>
            <div class="modal-body" style="padding:20px 0;">
                <input type="hidden" id="initEditId">
                
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;" id="initNameLabel">과제명 *</label>
                    <input type="text" class="input" id="initName" placeholder="예: KPI 대시보드 구축" style="width:100%;">
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px; font-weight:600; margin-bottom:6px;">
                        담당자
                        <span class="tooltip-icon" title="담당자 중복 선택 가능">ⓘ</span>
                    </label>
                    <div class="assignee-checkbox-container" id="initAssigneeCheckboxes"></div>
                    <input type="hidden" id="initAssignee" value="">
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;">상태</label>
                        <select class="select" id="initStatus" style="width:100%;">
                            <option value="진행중">진행중</option>
                            <option value="완료">완료</option>
                            <option value="보류">보류</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;">운영 상태</label>
                        <select class="select" id="initOpStatus" style="width:100%;">
                            <option value="미시작">미시작</option>
                            <option value="준비중">준비중</option>
                            <option value="운영중">운영중</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;">진행률</label>
                        <select class="select" id="initProgress" style="width:100%;" onchange="onProgressChange(this.value)">
                            <option value="0">0%</option>
                            <option value="10">10%</option>
                            <option value="20">20%</option>
                            <option value="30">30%</option>
                            <option value="40">40%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;">마감일</label>
                        <input type="date" class="input" id="initDueDate" style="width:100%;">
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px; padding-top:16px; border-top:1px solid var(--border-light);">
                <button class="btn btn-secondary" onclick="closeInitiativeModal()">취소</button>
                <button class="btn btn-primary" onclick="saveInitiative()">저장</button>
            </div>
        </div>
    </div>

    <!-- 모달 -->
    <div class="modal" id="modal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-avatar" id="modalAvatar">이름</div>
                <div>
                    <div class="modal-name" id="modalName">이름</div>
                    <div class="modal-dept" id="modalDept">부서</div>
                </div>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-stats">
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalProgress">0%</div>
                    <div class="modal-stat-label">평균 진척률</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalTasks">0</div>
                    <div class="modal-stat-label">담당 업무</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalDone">0</div>
                    <div class="modal-stat-label">완료</div>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- 변경 이력 모달 -->
    <div class="modal history-modal" id="historyModal">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <div class="modal-name" id="historyTaskName">업무명</div>
                    <div class="modal-dept">변경 이력</div>
                </div>
                <button class="modal-close" onclick="closeHistoryModal()">✕</button>
            </div>
            <div class="modal-body" id="historyBody"></div>
        </div>
    </div>

    <div class="toast" id="toast">저장되었습니다</div>

    <!-- KPI 수정 모달 -->
    <div class="modal kpi-modal" id="kpiModal">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <div class="modal-name" id="kpiModalTitle">팀 KPI 설정</div>
                    <div class="modal-dept" id="kpiModalSubtitle">그로스팀</div>
                </div>
                <button class="modal-close" onclick="closeKpiModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 미션 (필수) -->
                <div class="kpi-form-section">
                    <div class="kpi-form-label">
                        팀 미션 <span class="required">필수</span>
                    </div>
                    <textarea class="kpi-form-textarea" id="kpiMissionInput" placeholder="팀의 미션과 역할을 설명해주세요..."></textarea>
                </div>

                <!-- 메인 KPI (진척률 반영) -->
                <div class="kpi-form-section">
                    <label class="kpi-form-toggle">
                        <input type="checkbox" id="kpiMainMetricsToggle" onchange="toggleKpiMainMetrics()">
                        <div>
                            <div class="kpi-form-toggle-label">🎯 메인 KPI 추가</div>
                            <div class="kpi-form-toggle-desc">진척률 계산에 포함됩니다 (현재값/목표값 = 진척률)</div>
                        </div>
                    </label>
                    <div class="kpi-form-items" id="kpiMainMetricsItems" style="display:none;">
                        <div id="kpiMainMetricsList"></div>
                        <button class="btn-add-item" onclick="addMainMetricField()">+ 메인 KPI 추가</button>
                    </div>
                </div>

                <!-- 서브 KPI (참고용) -->
                <div class="kpi-form-section">
                    <label class="kpi-form-toggle">
                        <input type="checkbox" id="kpiSubMetricsToggle" onchange="toggleKpiSubMetrics()">
                        <div>
                            <div class="kpi-form-toggle-label">📋 서브 KPI 추가</div>
                            <div class="kpi-form-toggle-desc">참고용 지표입니다 (진척률 계산 제외)</div>
                        </div>
                    </label>
                    <div class="kpi-form-items" id="kpiSubMetricsItems" style="display:none;">
                        <div id="kpiSubMetricsList"></div>
                        <button class="btn-add-item" onclick="addSubMetricField()">+ 서브 KPI 추가</button>
                    </div>
                </div>

                <!-- 조건 (선택) -->
                <div class="kpi-form-section">
                    <label class="kpi-form-toggle">
                        <input type="checkbox" id="kpiConditionsToggle" onchange="toggleKpiConditions()">
                        <div>
                            <div class="kpi-form-toggle-label">조건 추가</div>
                            <div class="kpi-form-toggle-desc" id="kpiConditionsDesc">KPI 선정 기준이나 조건을 설정합니다 (선택)</div>
                        </div>
                    </label>
                    <div class="kpi-form-items" id="kpiConditionsItems">
                        <div id="kpiConditionsList"></div>
                        <button class="btn-add-item" onclick="addConditionField()">+ 조건 추가</button>
                    </div>
                </div>

                <!-- 대시보드 링크 (관리자 전용) -->
                <div class="kpi-form-section" id="kpiDashboardLinkSection" style="display:none;">
                    <div class="kpi-form-label">
                        🔗 상세 대시보드 링크 <span style="font-size:11px; color:var(--text-tertiary); font-weight:400;">(관리자 전용)</span>
                    </div>
                    <input type="url" class="input" id="kpiDashboardUrlInput" placeholder="https://docs.google.com/spreadsheets/..." style="width:100%; padding:12px; font-size:14px;">
                    <div style="font-size:12px; color:var(--text-tertiary); margin-top:6px;">
                        구글 시트, 노션 등 팀별 상세 대시보드 링크를 입력하세요
                    </div>
                </div>
            </div>
            <div class="kpi-modal-footer">
                <button class="btn btn-secondary" onclick="closeKpiModal()">취소</button>
                <button class="btn btn-primary" onclick="saveKpiData()">저장</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Supabase 연동 설정 ==========
        const SupabaseConfig = {
            url: 'https://gtdmqmanmzmtlgkkyasu.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0ZG1xbWFubXptdGxna2t5YXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc4ODQsImV4cCI6MjA4MzE3Mzg4NH0.DfBnMHhrgxgnE7uLSPewPZpp1D6OkTumFMeQu0V-B_8',
            enabled: true
        };

        // Supabase 클라이언트
        let supabaseClient = null;
        let isLoading = false;
        let autoRefreshInterval = null;

        // Initiative 데이터
        let initiativeData = [];

        // Supabase 클라이언트 초기화
        function initSupabase() {
            if (!SupabaseConfig.enabled || !SupabaseConfig.url || !SupabaseConfig.anonKey) {
                console.log('Supabase 연동 비활성화 상태 (로컬 저장소 사용)');
                return null;
            }
            
            const { createClient } = window.supabase;
            supabaseClient = createClient(SupabaseConfig.url, SupabaseConfig.anonKey);
            console.log('✅ Supabase 연결 완료');
            return supabaseClient;
        }

        // ========== Initiative 관리 (KPI 대시보드 DB) ==========
        
        // Initiative 데이터 로드
        async function loadInitiatives() {
            if (!supabaseClient) return [];
            
            try {
                const { data, error } = await supabaseClient
                    .from('initiatives')
                    .select('*')
                    .eq('sub_dept_id', curSub)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                initiativeData = data || [];
                console.log('✅ Initiative 로드 완료:', initiativeData.length, '개');
                return initiativeData;
            } catch (err) {
                console.error('❌ Initiative 로드 실패:', err);
                return [];
            }
        }

        // Initiative 생성
        async function createInitiative(init) {
            if (!supabaseClient) return null;
            
            console.log('📋 Initiative 생성 시작 - curSub:', curSub, 'init:', init);
            
            try {
                const { data, error } = await supabaseClient
                    .from('initiatives')
                    .insert({
                        sub_dept_id: curSub,
                        name: init.name,
                        assignee: init.assignee,
                        status: init.status,
                        operation_status: init.operationStatus,
                        progress: init.progress,
                        due_date: init.dueDate || null,
                        created_by: CURRENT_USER,
                        updated_by: CURRENT_USER
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                console.log('✅ Initiative 생성:', data.name);
                return data;
            } catch (err) {
                console.error('❌ Initiative 생성 실패:', err);
                return null;
            }
        }

        // Initiative 수정
        async function updateInitiative(id, updates) {
            if (!supabaseClient) return false;
            
            try {
                const { error } = await supabaseClient
                    .from('initiatives')
                    .update({
                        name: updates.name,
                        assignee: updates.assignee,
                        status: updates.status,
                        operation_status: updates.operationStatus,
                        progress: updates.progress,
                        due_date: updates.dueDate || null,
                        updated_at: new Date().toISOString(),
                        updated_by: CURRENT_USER
                    })
                    .eq('id', id);
                
                if (error) throw error;
                console.log('✅ Initiative 수정:', id);
                return true;
            } catch (err) {
                console.error('❌ Initiative 수정 실패:', err);
                return false;
            }
        }

        // Initiative 삭제
        async function deleteInitiative(id) {
            if (!supabaseClient) return false;
            
            try {
                const { error } = await supabaseClient
                    .from('initiatives')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                console.log('✅ Initiative 삭제:', id);
                return true;
            } catch (err) {
                console.error('❌ Initiative 삭제 실패:', err);
                return false;
            }
        }

        // Initiative 목록 렌더링
        function renderInitiatives() {
            const container = document.getElementById('initiativeList');
            if (!container) return;
            
            const termTitle = getTermLabel('title');
            const termAdd = getTermLabel('add');
            const termEmpty = getTermLabel('empty');
            const icon = curSub === 'growth' ? '📋' : '🎯';

            // 권한 체크
            const canEdit = canEditTeam(curSub);

            // Initiative 추가 버튼 표시/숨김
            const addBtn = document.getElementById('initAddBtn');
            if (addBtn) {
                addBtn.style.display = canEdit ? 'block' : 'none';
            }
            
            if (initiativeData.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--text-tertiary);">
                        <div style="font-size:32px; margin-bottom:12px;">${icon}</div>
                        <div>등록된 ${termEmpty} 없습니다</div>
                        ${canEdit ? `<button class="btn btn-primary" onclick="openInitiativeModal()" style="margin-top:16px;">+ ${termAdd}</button>` : ''}
                    </div>
                `;
                updateInitiativeStats();
                return;
            }
            
            updateInitiativeStats();
            
            // 목록 렌더링
            container.innerHTML = initiativeData.map(init => {
                const statusClass = init.operation_status === '운영중' ? 'operating' 
                    : init.operation_status === '준비중' ? 'preparing' : 'not-started';
                const statusText = init.operation_status === '운영중' ? '운영 중' 
                    : init.operation_status === '준비중' ? '준비 중' : '미시작';
                const statusBadge = init.status === '완료' ? '✅' : init.status === '보류' ? '⏸️' : '🔥';
                
                // 담당자 표시 (1명: 직급포함, 2명이상: 이름만)
                const assigneeDisplay = formatAssigneeDisplay(init.assignee);
                
                return `
                    <div class="initiative-item">
                        <div class="init-status ${statusClass}"></div>
                        <div class="init-info">
                            <div class="init-name">${statusBadge} ${init.name}</div>
                            <div class="init-meta">
                                <span>📅 ${init.due_date || '일정 미설정'}</span>
                                <span>상태: ${init.status}</span>
                            </div>
                        </div>
                        <div class="init-assignee">${assigneeDisplay}</div>
                        <div class="init-operation ${statusClass}">${statusText}</div>
                        <div class="init-progress">
                            <div class="init-progress-bar">
                                <div class="init-progress-fill" style="width:${init.progress}%"></div>
                            </div>
                            <div class="init-progress-text">${init.progress}%</div>
                        </div>
                        ${canEdit ? `
                        <div class="init-actions">
                            <button class="init-action-btn edit" onclick="editInitiative('${init.id}')">수정</button>
                            <button class="init-action-btn delete" onclick="confirmDeleteInitiative('${init.id}', '${init.name}')">삭제</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // 담당자 표시 포맷 (1명: 직급포함, 2명이상: 이름만)
        function formatAssigneeDisplay(assignee) {
            if (!assignee || assignee === '-') return '-';
            
            const members = assignee.split(', ').filter(Boolean);
            
            if (members.length === 1) {
                // 1명: 그대로 표시 (직급 포함)
                return members[0];
            } else {
                // 2명 이상: 이름만 표시
                return members.map(m => {
                    // "이재훈 리드매니저" → "이재훈"
                    const namePart = m.split(' ')[0];
                    return namePart;
                }).join(', ');
            }
        }

        // Initiative 통계 업데이트
        function updateInitiativeStats() {
            const inProgress = initiativeData.filter(i => i.status === '진행중').length;
            const completed = initiativeData.filter(i => i.status === '완료').length;
            const operating = initiativeData.filter(i => i.operation_status === '운영중').length;
            const total = initiativeData.length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('initInProgress').textContent = inProgress;
            document.getElementById('initCompleted').textContent = completed;
            document.getElementById('initOperating').textContent = operating;
            document.getElementById('initRate').textContent = rate + '%';
        }

        // Initiative 모달 열기 (추가)
        function openInitiativeModal() {
            document.getElementById('initModalTitle').textContent = getTermLabel('add');
            document.getElementById('initNameLabel').textContent = getTermLabel('name') + ' *';
            document.getElementById('initEditId').value = '';
            document.getElementById('initName').value = '';
            document.getElementById('initStatus').value = '진행중';
            document.getElementById('initOpStatus').value = '미시작';
            document.getElementById('initProgress').value = '0';
            document.getElementById('initDueDate').value = '';
            
            // 담당자 목록 업데이트 (빈 배열)
            updateInitAssignees([]);
            
            document.getElementById('initiativeModal').classList.add('show');
        }

        // Initiative 모달 열기 (수정)
        function editInitiative(id) {
            const init = initiativeData.find(i => i.id === id);
            if (!init) return;
            
            document.getElementById('initModalTitle').textContent = getTermLabel('edit');
            document.getElementById('initNameLabel').textContent = getTermLabel('name') + ' *';
            document.getElementById('initEditId').value = id;
            document.getElementById('initName').value = init.name;
            document.getElementById('initStatus').value = init.status;
            document.getElementById('initOpStatus').value = init.operation_status;
            document.getElementById('initProgress').value = init.progress;
            document.getElementById('initDueDate').value = init.due_date || '';
            
            // 담당자 목록 업데이트 (기존 담당자 체크)
            updateInitAssignees(init.assignee || '');
            
            document.getElementById('initiativeModal').classList.add('show');
        }

        // Initiative 모달 닫기
        function closeInitiativeModal() {
            document.getElementById('initiativeModal').classList.remove('show');
        }

        // Initiative 담당자 목록 업데이트 (체크박스 방식)
        function updateInitAssignees(selectedAssignees = []) {
            const container = document.getElementById('initAssigneeCheckboxes');
            const d = ORG.departments.find(x => x.id === curDept);
            const sub = d?.subDepts.find(s => s.id === curSub);
            
            if (!sub || !sub.members) {
                container.innerHTML = '<span style="color:var(--text-tertiary);font-size:13px;">팀원이 없습니다</span>';
                return;
            }

            // 선택된 담당자 배열로 변환
            const selectedArray = Array.isArray(selectedAssignees) 
                ? selectedAssignees 
                : (selectedAssignees ? selectedAssignees.split(', ').filter(Boolean) : []);

            container.innerHTML = sub.members.map(m => {
                // 문자열 또는 객체 처리
                const memberStr = typeof m === 'string' ? m : `${m.name} ${m.role}`;
                const memberName = typeof m === 'string' ? m.split(' ')[0] : m.name;
                const isSelected = selectedArray.includes(memberStr) || selectedArray.some(s => s.includes(memberName));
                return `
                    <label class="assignee-checkbox-item ${isSelected ? 'selected' : ''}" onclick="toggleAssignee(this, '${memberStr.replace(/'/g, "\\'")}')">
                        <input type="checkbox" value="${memberStr}" ${isSelected ? 'checked' : ''}>
                        ${memberName}
                    </label>
                `;
            }).join('');

            // hidden input 업데이트
            updateAssigneeHiddenInput();
        }

        // 담당자 토글
        function toggleAssignee(label, member) {
            const checkbox = label.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            label.classList.toggle('selected', checkbox.checked);
            updateAssigneeHiddenInput();
        }

        // hidden input 값 업데이트
        function updateAssigneeHiddenInput() {
            const container = document.getElementById('initAssigneeCheckboxes');
            const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const selectedMembers = Array.from(checkedBoxes).map(cb => cb.value);
            document.getElementById('initAssignee').value = selectedMembers.join(', ');
        }

        // 진행률 변경 시 상태 자동 변경
        // 100% → "완료", 100% 미만 → "진행중" (완료 상태에서 변경 시)
        function onProgressChange(value) {
            const statusSelect = document.getElementById('initStatus');
            const progressValue = parseInt(value);
            
            if (progressValue === 100) {
                // 100%면 완료로 변경
                statusSelect.value = '완료';
            } else if (statusSelect.value === '완료') {
                // 완료 상태에서 100% 미만으로 변경하면 진행중으로 복귀
                statusSelect.value = '진행중';
            }
        }

        // ========== 대시보드 링크 관리 (관리자 전용) ==========
        
        // 팀별 대시보드 링크 저장소
        let dashboardLinks = {};

        // 대시보드 링크 로드
        function loadDashboardLinks() {
            const saved = localStorage.getItem('netform_dashboard_links');
            if (saved) {
                dashboardLinks = JSON.parse(saved);
            }
        }

        // 대시보드 링크 저장
        function saveDashboardLinksToStorage() {
            localStorage.setItem('netform_dashboard_links', JSON.stringify(dashboardLinks));
        }

        // URL 유효성 검사
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Initiative 저장
        async function saveInitiative() {
            console.log('💾 Initiative 저장 시작 - curSub:', curSub);
            
            const name = document.getElementById('initName').value.trim();
            if (!name) {
                alert('Initiative 이름을 입력하세요.');
                return;
            }
            
            const initData = {
                name,
                assignee: document.getElementById('initAssignee').value,
                status: document.getElementById('initStatus').value,
                operationStatus: document.getElementById('initOpStatus').value,
                progress: parseInt(document.getElementById('initProgress').value),
                dueDate: document.getElementById('initDueDate').value
            };
            
            console.log('💾 저장할 데이터:', initData);
            
            const editId = document.getElementById('initEditId').value;
            
            if (editId) {
                // 수정
                const success = await updateInitiative(editId, initData);
                if (success) {
                    toast(`✏️ ${getTermLabel('title')}가 수정되었습니다`);
                } else {
                    console.error('❌ Initiative 수정 실패');
                }
            } else {
                // 추가
                const result = await createInitiative(initData);
                if (result) {
                    toast(`✅ ${getTermLabel('title')}가 추가되었습니다`);
                    console.log('✅ 저장 성공:', result);
                } else {
                    console.error('❌ Initiative 추가 실패');
                    toast('❌ 저장 실패. 콘솔을 확인하세요.');
                }
            }
            
            closeInitiativeModal();
            await loadInitiatives();
            renderInitiatives();
            updateLastUpdateTime();
        }

        // Initiative 삭제 확인
        function confirmDeleteInitiative(id, name) {
            if (confirm(`"${name}" ${getTermLabel('title')}를 삭제하시겠습니까?`)) {
                deleteInitiativeById(id);
            }
        }

        // Initiative 삭제 실행
        async function deleteInitiativeById(id) {
            const success = await deleteInitiative(id);
            if (success) {
                toast(`🗑️ ${getTermLabel('title')}가 삭제되었습니다`);
                await loadInitiatives();
                renderInitiatives();
                updateLastUpdateTime();
            }
        }

        // 자동 새로고침 시작 (30초)
        function startAutoRefresh() {
            // 기존 인터벌 제거
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // 30초마다 새로고침
            autoRefreshInterval = setInterval(async () => {
                console.log('🔄 자동 새로고침...');
                await refreshAllData();
                updateLastUpdateTime();
            }, 30000);
            
            console.log('⏰ 자동 새로고침 시작 (30초 간격)');
        }

        // 전체 데이터 새로고침
        async function refreshAllData() {
            if (supabaseClient) {
                await loadTasksFromSupabase();
                await loadKpiFromSupabase();
                if (curSub) {
                    await loadInitiatives();
                }
            }
            
            calcAll();
            renderDeptGrid();
            
            // 상세 페이지 열려있으면 업데이트
            if (curDept && curSub) {
                renderInitiatives();
                renderKpiSection();
            }
        }

        // Realtime 구독
        function subscribeToChanges() {
            if (!supabaseClient) return;

            // tasks 테이블 변경 구독
            supabaseClient
                .channel('tasks-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, async (payload) => {
                    console.log('📡 Task 변경:', payload);
                    await loadTasksFromSupabase();
                    calcAll();
                    renderDeptGrid();
                    toast('🔄 데이터가 동기화되었습니다');
                })
                .subscribe();

            // team_kpis 테이블 변경 구독
            supabaseClient
                .channel('kpi-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'team_kpis' }, async (payload) => {
                    console.log('📡 KPI 변경:', payload);
                    await loadKpiFromSupabase();
                    if (curSub) renderKpiSection();
                })
                .subscribe();

            // initiatives 테이블 변경 구독
            supabaseClient
                .channel('initiatives-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'initiatives' }, async (payload) => {
                    console.log('📡 Initiative 변경:', payload);
                    if (curSub) {
                        await loadInitiatives();
                        renderInitiatives();
                    }
                    toast('🔄 데이터가 동기화되었습니다');
                })
                .subscribe();
            
            console.log('📡 Realtime 구독 시작');
        }

        // ========== Tasks CRUD ==========
        
        // Tasks 로드
        async function loadTasksFromSupabase() {
            if (!supabaseClient) return false;
            
            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // sub_dept_id별로 그룹화
                taskData = {};
                data.forEach(task => {
                    if (!taskData[task.sub_dept_id]) {
                        taskData[task.sub_dept_id] = [];
                    }
                    taskData[task.sub_dept_id].push({
                        id: task.id,
                        name: task.name,
                        assignee: task.assignee,
                        progress: task.progress,
                        priority: task.priority,
                        dueDate: task.due_date,
                        createdAt: task.created_at,
                        updatedAt: task.updated_at,
                        updatedBy: task.updated_by
                    });
                });
                
                console.log('✅ Tasks 로드 완료:', Object.keys(taskData).length, '개 팀');
                return true;
            } catch (err) {
                console.error('❌ Tasks 로드 실패:', err);
                return false;
            }
        }

        // Task 생성
        async function createTaskInSupabase(subDeptId, task) {
            if (!supabaseClient) return null;
            
            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .insert({
                        sub_dept_id: subDeptId,
                        name: task.name,
                        assignee: task.assignee,
                        progress: task.progress,
                        priority: task.priority,
                        due_date: task.dueDate,
                        created_by: CURRENT_USER,
                        updated_by: CURRENT_USER
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Activity log
                await addActivityLogToSupabase(data.id, task.name, 'create', null, null, null);
                
                console.log('✅ Task 생성:', data.name);
                return data;
            } catch (err) {
                console.error('❌ Task 생성 실패:', err);
                return null;
            }
        }

        // Task 업데이트
        async function updateTaskInSupabase(taskId, updates, oldTask) {
            if (!supabaseClient) return false;
            
            try {
                const updateData = {
                    updated_at: new Date().toISOString(),
                    updated_by: CURRENT_USER
                };
                
                if (updates.name !== undefined) updateData.name = updates.name;
                if (updates.assignee !== undefined) updateData.assignee = updates.assignee;
                if (updates.progress !== undefined) updateData.progress = updates.progress;
                if (updates.priority !== undefined) updateData.priority = updates.priority;
                if (updates.dueDate !== undefined) updateData.due_date = updates.dueDate;
                
                const { error } = await supabaseClient
                    .from('tasks')
                    .update(updateData)
                    .eq('id', taskId);
                
                if (error) throw error;
                
                // Activity log for each changed field
                for (const [key, value] of Object.entries(updates)) {
                    if (oldTask[key] !== value) {
                        await addActivityLogToSupabase(
                            taskId, 
                            oldTask.name, 
                            'update', 
                            key, 
                            String(oldTask[key] || ''), 
                            String(value || '')
                        );
                    }
                }
                
                console.log('✅ Task 업데이트:', taskId);
                return true;
            } catch (err) {
                console.error('❌ Task 업데이트 실패:', err);
                return false;
            }
        }

        // Task 삭제
        async function deleteTaskInSupabase(taskId, taskName) {
            if (!supabaseClient) return false;
            
            try {
                const { error } = await supabaseClient
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);
                
                if (error) throw error;
                
                console.log('✅ Task 삭제:', taskId);
                return true;
            } catch (err) {
                console.error('❌ Task 삭제 실패:', err);
                return false;
            }
        }

        // ========== Activity Logs ==========
        
        async function addActivityLogToSupabase(taskId, taskName, action, field, oldValue, newValue) {
            if (!supabaseClient) return;
            
            try {
                await supabaseClient
                    .from('activity_logs')
                    .insert({
                        task_id: taskId,
                        task_name: taskName,
                        action: action,
                        field: field,
                        old_value: oldValue,
                        new_value: newValue,
                        created_by: CURRENT_USER
                    });
            } catch (err) {
                console.error('Activity log 저장 실패:', err);
            }
        }

        async function getActivityLogsFromSupabase(taskId) {
            if (!supabaseClient) return [];
            
            try {
                const { data, error } = await supabaseClient
                    .from('activity_logs')
                    .select('*')
                    .eq('task_id', taskId)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Activity logs 로드 실패:', err);
                return [];
            }
        }

        // ========== Team KPIs ==========
        
        async function loadKpiFromSupabase() {
            if (!supabaseClient) return false;
            
            try {
                const { data, error } = await supabaseClient
                    .from('team_kpis')
                    .select('*');
                
                if (error) throw error;
                
                // sub_dept_id를 키로 하는 객체로 변환
                kpiData = {};
                data.forEach(kpi => {
                    kpiData[kpi.sub_dept_id] = {
                        id: kpi.id,
                        mission: kpi.mission,
                        mainMetrics: kpi.main_metrics || [],
                        subMetrics: kpi.sub_metrics || [],
                        conditions: kpi.conditions || [],
                        dashboardUrl: kpi.dashboard_url || '',
                        updated_at: kpi.updated_at,
                        updated_by: kpi.updated_by
                    };
                });
                
                console.log('✅ KPI 로드 완료:', Object.keys(kpiData).length, '개 팀');
                return true;
            } catch (err) {
                console.error('❌ KPI 로드 실패:', err);
                return false;
            }
        }

        async function saveKpiToSupabase(subDeptId, kpiInfo) {
            if (!supabaseClient) return false;
            
            try {
                const { error } = await supabaseClient
                    .from('team_kpis')
                    .upsert({
                        sub_dept_id: subDeptId,
                        mission: kpiInfo.mission,
                        main_metrics: kpiInfo.mainMetrics || [],
                        sub_metrics: kpiInfo.subMetrics || [],
                        metrics: [], // 레거시 필드 (호환성)
                        conditions: kpiInfo.conditions,
                        dashboard_url: kpiInfo.dashboardUrl || null,
                        updated_at: new Date().toISOString(),
                        updated_by: CURRENT_USER
                    }, { onConflict: 'sub_dept_id' });
                
                if (error) throw error;
                
                console.log('✅ KPI 저장:', subDeptId);
                return true;
            } catch (err) {
                console.error('❌ KPI 저장 실패:', err);
                return false;
            }
        }

        // ========== 초기 더미 데이터 삽입 ==========
        
        async function insertDummyDataToSupabase() {
            if (!supabaseClient) return;
            
            const dummyData = generateDummyData();
            
            for (const [subDeptId, tasks] of Object.entries(dummyData)) {
                for (const task of tasks) {
                    await supabaseClient.from('tasks').insert({
                        sub_dept_id: subDeptId,
                        name: task.name,
                        assignee: task.assignee,
                        progress: task.progress,
                        priority: task.priority,
                        due_date: task.dueDate,
                        created_by: task.updatedBy,
                        updated_by: task.updatedBy
                    });
                }
            }
            
            // 그로스팀 KPI 삽입
            await supabaseClient.from('team_kpis').insert({
                sub_dept_id: 'growth',
                mission: '그로스팀은 전사 운영과 성과를 구조적으로 관리하며, 성장을 위해 필요한 기능·서비스·협업 모델을 기획에 그치지 않고 실제로 구현하는 팀입니다.',
                metrics: [
                    { label: '이니셔티브 완료 수', value: '12', unit: '건', period: '연간' },
                    { label: '진행 중 이니셔티브', value: '2~4', unit: '건', period: '' },
                    { label: '운영 지속률', value: '80', unit: '%↑', period: '' }
                ],
                conditions: [
                    '회사의 성장(매출·운영·조직·경영)에 실질적 영향을 주는 문제일 것',
                    '단순 요청이 아니라 구조·방식·수단을 바꿔야 해결되는 문제일 것',
                    '그로스팀이 문제 정의부터 해결 구조 설계, 실행 결과물까지 책임질 것',
                    '결과가 재사용 가능하거나, 다음 성과로 이어질 구조를 남길 것'
                ],
                updated_by: '김범석 매니저'
            });
            
            console.log('✅ 더미 데이터 삽입 완료');
        }

        // ========== 전역 상태 ==========
        const CURRENT_USER = '김범석 매니저'; // 현재 로그인 사용자
        const GOAL_TARGET = 80; // 목표 진척률

        // 활동 로그
        let activityLogs = [];

        // 마지막 업데이트 시간
        let lastUpdateTime = new Date();

        const ORG = {
            departments: [
                {
                    id: 'sales', name: '영업본부', color: 'blue',
                    leader: '황윤선', leaderFull: '황윤선 상무이사', headcount: 11,
                    subDepts: [
                        { id: 'sales_1', name: '서비스운영 1팀', members: ['한준엽 리드매니저', '조재연 매니저', '정정훈 매니저', '김성민 매니저', '한지혜 매니저', '김경미 매니저'] },
                        { id: 'sales_2', name: '서비스운영 2팀', members: ['권정아 리드매니저', '김수진 매니저', '이지연 매니저'] },
                        { id: 'sales_3', name: '서비스운영 3팀', members: ['주현진 리드매니저', '송보람 매니저'] },
                        { id: 'sales_team', name: '영업팀', members: ['이필선 매니저'] }
                    ]
                },
                {
                    id: 'design', name: '설계/적산팀', color: 'purple',
                    leader: '조현식', leaderFull: '조현식 이사', headcount: 4,
                    subDepts: [
                        { id: 'apt_square', name: '아파트스퀘어팀', members: ['한인규 리드매니저', '김영성 매니저', '신수진 매니저', '정태윤 매니저'] }
                    ]
                },
                {
                    id: 'mgmt', name: '경영관리본부', color: 'orange',
                    leader: '백정석', leaderFull: '백정석 이사', headcount: 6,
                    subDepts: [
                        { id: 'mgmt_team', name: '경영관리팀', members: ['신나영 리드매니저', '주유진 매니저', '최영옥 매니저', '김유림 매니저'] },
                        { id: 'growth', name: '그로스팀', members: ['이재훈 리드매니저', '김범석 매니저'] }
                    ]
                },
                {
                    id: 'brand', name: '브랜드마케팅팀', color: 'pink',
                    leader: '권혜영', leaderFull: '권혜영 리드매니저', headcount: 5,
                    subDepts: [
                        { id: 'brand_team', name: '브랜드마케팅팀', members: ['권혜영 리드매니저', '함지민 매니저', '김소라 매니저', '손예진 매니저', '최경선 매니저'] }
                    ]
                },
                {
                    id: 'commerce', name: '커머스사업본부', color: 'cyan',
                    leader: '허지은', leaderFull: '허지은 리드매니저', headcount: 8,
                    subDepts: [
                        { id: 'brand_comm', name: '브랜드커머스팀', members: ['허지은 리드매니저', '이란 매니저'] },
                        { id: 'media_comm', name: '미디어커머스팀', members: ['허지은 리드매니저', '방현수 리드매니저', '김소연 매니저', '남윤정 매니저'] },
                        { id: 'overseas', name: '해외사업팀', members: ['허지은 리드매니저', '김채원 매니저', '쩐티리 매니저'] },
                        { id: 'moyeora', name: '모여라딜팀', members: ['허지은 리드매니저', '김송희 리드매니저', '이채은 매니저'] }
                    ]
                },
                {
                    id: 'rnd', name: '기술연구소', color: 'purple',
                    leader: '이정훈 / 신명희',
                    leaderFull: '이정훈 연구소장 / 신명희 선임연구원',
                    headcount: 4,
                    subDepts: [
                        { id: 'rnd_team', name: '기술연구소', members: [
                            { name: '이정훈', role: '연구소장' },
                            { name: '신명희', role: '선임연구원' },
                            { name: '심혜진', role: '연구원' },
                            { name: '김소정', role: '연구원' }
                        ]}
                    ]
                },
                {
                    id: 'factory', name: '용인공장', color: 'green',
                    leader: '정영재 / 김성준', leaderFull: '정영재 부사장 / 김성준 공장장', headcount: 4,
                    subDepts: [
                        { id: 'factory_team', name: '용인공장', members: ['김성준 공장장', '이재민 리드매니저', '이나라 매니저', '김유진 매니저'] }
                    ]
                }
            ]
        };

        let taskData = {};
        let kpiData = {}; // KPI 데이터 저장
        let curDept = null, curSub = null, editIdx = null;
        let barChart = null, donutChart = null;
        let isPresentationMode = false;

        // 그로스팀 기본 KPI 데이터
        const DEFAULT_KPI_DATA = {
            'growth': {
                mission: '그로스팀은 전사 운영과 성과를 구조적으로 관리하며, 성장을 위해 필요한 기능·서비스·협업 모델을 기획에 그치지 않고 실제로 구현하는 팀입니다.',
                metrics: [
                    { label: '이니셔티브 완료 수', value: '12', unit: '건', period: '연간' },
                    { label: '진행 중 이니셔티브', value: '2~4', unit: '건', period: '' },
                    { label: '운영 지속률', value: '80', unit: '%↑', period: '' }
                ],
                conditions: [
                    '회사의 성장(매출·운영·조직·경영)에 실질적 영향을 주는 문제일 것',
                    '단순 요청이 아니라 구조·방식·수단을 바꿔야 해결되는 문제일 것',
                    '그로스팀이 문제 정의부터 해결 구조 설계, 실행 결과물까지 책임질 것',
                    '결과가 재사용 가능하거나, 다음 성과로 이어질 구조를 남길 것'
                ]
            }
        };

        // 더미 데이터 생성 (확장된 구조)
        function generateDummyData() {
            const now = new Date().toISOString();
            return {
                'sales_1': [
                    { name: '1분기 영업 목표 수립', assignee: '한준엽 리드매니저', progress: 100, priority: 'high', dueDate: '2026-01-15', createdAt: now, updatedAt: now, updatedBy: '한준엽 리드매니저' },
                    { name: '신규 거래처 발굴', assignee: '조재연 매니저', progress: 80, priority: 'high', dueDate: '2026-01-20', createdAt: now, updatedAt: now, updatedBy: '조재연 매니저' },
                    { name: '기존 고객 유지 관리', assignee: '정정훈 매니저', progress: 70, priority: 'medium', dueDate: '2026-01-25', createdAt: now, updatedAt: now, updatedBy: '정정훈 매니저' },
                    { name: '영업 실적 보고서 작성', assignee: '김성민 매니저', progress: 90, priority: 'medium', dueDate: '2026-01-10', createdAt: now, updatedAt: now, updatedBy: '김성민 매니저' },
                    { name: '고객 만족도 조사', assignee: '한지혜 매니저', progress: 60, priority: 'low', dueDate: '2026-01-30', createdAt: now, updatedAt: now, updatedBy: '한지혜 매니저' }
                ],
                'sales_2': [
                    { name: '서비스 운영 매뉴얼 정비', assignee: '권정아 리드매니저', progress: 100, priority: 'high', dueDate: '2026-01-08', createdAt: now, updatedAt: now, updatedBy: '권정아 리드매니저' },
                    { name: '고객 응대 프로세스 개선', assignee: '김수진 매니저', progress: 85, priority: 'medium', dueDate: '2026-01-18', createdAt: now, updatedAt: now, updatedBy: '김수진 매니저' }
                ],
                'sales_3': [
                    { name: 'CS 응대 시스템 구축', assignee: '주현진 리드매니저', progress: 75, priority: 'high', dueDate: '2026-01-22', createdAt: now, updatedAt: now, updatedBy: '주현진 리드매니저' },
                    { name: '불만 고객 케어 프로그램', assignee: '송보람 매니저', progress: 20, priority: 'medium', dueDate: '2026-01-28', createdAt: now, updatedAt: now, updatedBy: '송보람 매니저' }
                ],
                'sales_team': [
                    { name: '신규 계약 10건 달성', assignee: '이필선 매니저', progress: 25, priority: 'high', dueDate: '2026-01-31', createdAt: now, updatedAt: now, updatedBy: '이필선 매니저' }
                ],
                'apt_square': [
                    { name: '아파트스퀘어 2.0 기획', assignee: '한인규 리드매니저', progress: 65, priority: 'high', dueDate: '2026-02-01', createdAt: now, updatedAt: now, updatedBy: '한인규 리드매니저' },
                    { name: '적산 시스템 고도화', assignee: '김영성 매니저', progress: 90, priority: 'high', dueDate: '2026-01-20', createdAt: now, updatedAt: now, updatedBy: '김영성 매니저' },
                    { name: '원가 분석 리포트', assignee: '신수진 매니저', progress: 70, priority: 'medium', dueDate: '2026-01-15', createdAt: now, updatedAt: now, updatedBy: '신수진 매니저' }
                ],
                'mgmt_team': [
                    { name: '2026 예산 편성', assignee: '신나영 리드매니저', progress: 100, priority: 'high', dueDate: '2026-01-05', createdAt: now, updatedAt: now, updatedBy: '신나영 리드매니저' },
                    { name: '분기별 재무제표 작성', assignee: '주유진 매니저', progress: 80, priority: 'high', dueDate: '2026-01-10', createdAt: now, updatedAt: now, updatedBy: '주유진 매니저' },
                    { name: '인사 평가 시스템 개선', assignee: '최영옥 매니저', progress: 60, priority: 'medium', dueDate: '2026-01-25', createdAt: now, updatedAt: now, updatedBy: '최영옥 매니저' },
                    { name: '복리후생 프로그램 기획', assignee: '김유림 매니저', progress: 45, priority: 'low', dueDate: '2026-02-15', createdAt: now, updatedAt: now, updatedBy: '김유림 매니저' }
                ],
                'growth': [
                    { name: 'KPI 대시보드 개발', assignee: '이재훈 리드매니저', progress: 95, priority: 'high', dueDate: '2026-01-05', createdAt: now, updatedAt: now, updatedBy: '이재훈 리드매니저' },
                    { name: '데이터 분석 자동화', assignee: '김범석 매니저', progress: 85, priority: 'high', dueDate: '2026-01-15', createdAt: now, updatedAt: now, updatedBy: '김범석 매니저' }
                ],
                'brand_team': [
                    { name: '브랜드 리뉴얼 프로젝트', assignee: '권혜영 리드매니저', progress: 70, priority: 'high', dueDate: '2026-02-01', createdAt: now, updatedAt: now, updatedBy: '권혜영 리드매니저' },
                    { name: 'SNS 콘텐츠 기획', assignee: '함지민 매니저', progress: 80, priority: 'medium', dueDate: '2026-01-20', createdAt: now, updatedAt: now, updatedBy: '함지민 매니저' },
                    { name: '보도자료 배포', assignee: '김소라 매니저', progress: 100, priority: 'medium', dueDate: '2026-01-08', createdAt: now, updatedAt: now, updatedBy: '김소라 매니저' }
                ],
                'brand_comm': [
                    { name: '브랜드 커머스 전략 수립', assignee: '이란 매니저', progress: 60, priority: 'high', dueDate: '2026-01-25', createdAt: now, updatedAt: now, updatedBy: '이란 매니저' }
                ],
                'media_comm': [
                    { name: '라이브커머스 운영', assignee: '방현수 리드매니저', progress: 90, priority: 'high', dueDate: '2026-01-15', createdAt: now, updatedAt: now, updatedBy: '방현수 리드매니저' },
                    { name: '인플루언서 협업', assignee: '김소연 매니저', progress: 75, priority: 'medium', dueDate: '2026-01-22', createdAt: now, updatedAt: now, updatedBy: '김소연 매니저' },
                    { name: '광고 성과 분석', assignee: '남윤정 매니저', progress: 85, priority: 'medium', dueDate: '2026-01-18', createdAt: now, updatedAt: now, updatedBy: '남윤정 매니저' }
                ],
                'overseas': [
                    { name: '해외 시장 조사', assignee: '김채원 매니저', progress: 50, priority: 'high', dueDate: '2026-02-01', createdAt: now, updatedAt: now, updatedBy: '김채원 매니저' },
                    { name: '현지 파트너십 구축', assignee: '쩐티리 매니저', progress: 15, priority: 'medium', dueDate: '2026-03-01', createdAt: now, updatedAt: now, updatedBy: '쩐티리 매니저' }
                ],
                'moyeora': [
                    { name: '모여라딜 플랫폼 개선', assignee: '김송희 리드매니저', progress: 80, priority: 'high', dueDate: '2026-01-20', createdAt: now, updatedAt: now, updatedBy: '김송희 리드매니저' },
                    { name: '딜 상품 소싱', assignee: '이채은 매니저', progress: 70, priority: 'medium', dueDate: '2026-01-25', createdAt: now, updatedAt: now, updatedBy: '이채은 매니저' }
                ],
                'rnd_team': [
                    { name: 'AI 결함 진단 모델 개발', assignee: '신명희 선임연구원', progress: 85, priority: 'high', dueDate: '2026-02-15', createdAt: now, updatedAt: now, updatedBy: '신명희 선임연구원' },
                    { name: '특허 출원 준비', assignee: '심혜진 연구원', progress: 60, priority: 'high', dueDate: '2026-01-31', createdAt: now, updatedAt: now, updatedBy: '심혜진 연구원' },
                    { name: '신기술 리서치', assignee: '김소정 연구원', progress: 40, priority: 'low', dueDate: '2026-02-28', createdAt: now, updatedAt: now, updatedBy: '김소정 연구원' }
                ],
                'factory_team': [
                    { name: '공장 운영 효율화', assignee: '이나라 매니저', progress: 75, priority: 'medium', dueDate: '2026-01-25', createdAt: now, updatedAt: now, updatedBy: '이나라 매니저' },
                    { name: '생산 라인 최적화', assignee: '이재민 리드매니저', progress: 90, priority: 'high', dueDate: '2026-01-18', createdAt: now, updatedAt: now, updatedBy: '이재민 리드매니저' },
                    { name: '품질 관리 시스템 구축', assignee: '김유진 매니저', progress: 65, priority: 'high', dueDate: '2026-02-01', createdAt: now, updatedAt: now, updatedBy: '김유진 매니저' }
                ]
            };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 로딩 표시
            showLoading(true);
            
            try {
                // Supabase 초기화
                initSupabase();
                
                // 대시보드 링크 로드
                loadDashboardLinks();
                
                if (supabaseClient && SupabaseConfig.enabled) {
                    // Supabase에서 데이터 로드
                    const tasksLoaded = await loadTasksFromSupabase();
                    const kpiLoaded = await loadKpiFromSupabase();
                    
                    // 데이터 없으면 더미 데이터 삽입
                    if (tasksLoaded && Object.keys(taskData).length === 0) {
                        console.log('📝 더미 데이터 삽입 중...');
                        await insertDummyDataToSupabase();
                        await loadTasksFromSupabase();
                        await loadKpiFromSupabase();
                    }
                    
                    // 실시간 구독 시작
                    subscribeToChanges();
                } else {
                    // localStorage 사용 (오프라인 모드)
                    loadData();
                    loadKpiData();
                    if (Object.keys(taskData).length === 0) {
                        taskData = generateDummyData();
                        saveData();
                    }
                }
                
                renderNav();
                calcAll();
                renderDeptGrid();
                initCharts();
                updateLastUpdateTime();
                animateProgressBars();
                animateCountUp();
                
                // 자동 새로고침 시작 (30초)
                startAutoRefresh();
                addAutoRefreshIndicator();
                
                // Initiative 모달 클릭 이벤트
                document.getElementById('initiativeModal')?.addEventListener('click', e => {
                    if (e.target.id === 'initiativeModal') closeInitiativeModal();
                });
                
                // 전시용 자동 복귀 기능 시작 (50초 유휴 시 메인으로)
                startIdleTimer();
            } catch (err) {
                console.error('초기화 에러:', err);
            }
            
            showLoading(false);
        });
        
        // ========== 전시용 자동 복귀 기능 (50초 유휴 시 메인 페이지로) ==========
        let idleTimer = null;
        const IDLE_TIMEOUT = 50000; // 50초

        function startIdleTimer() {
            // 활동 감지 이벤트 등록
            const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, resetIdleTimer, { passive: true });
            });
            
            // 타이머 시작
            resetIdleTimer();
            console.log('⏱️ 전시 모드: 50초 유휴 시 메인 페이지로 자동 복귀');
        }

        function resetIdleTimer() {
            // 기존 타이머 제거
            if (idleTimer) {
                clearTimeout(idleTimer);
            }
            
            // 새 타이머 시작
            idleTimer = setTimeout(() => {
                // 상세 페이지에 있을 때만 메인으로 이동
                if (curDept !== null) {
                    console.log('⏱️ 50초 유휴 감지 → 메인 페이지로 이동');
                    goMain();
                    toast('🏠 메인 화면으로 돌아왔습니다');
                }
            }, IDLE_TIMEOUT);
        }
        
        // 자동 새로고침 표시 추가
        function addAutoRefreshIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'auto-refresh-indicator';
            indicator.innerHTML = '<div class="refresh-dot"></div><span>30초마다 자동 새로고침</span>';
            document.body.appendChild(indicator);
        }
        
        // 로딩 표시 함수
        function showLoading(show) {
            let loader = document.getElementById('globalLoader');
            if (!loader && show) {
                loader = document.createElement('div');
                loader.id = 'globalLoader';
                loader.innerHTML = `
                    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;">
                        <div style="text-align:center;">
                            <div style="width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
                            <div style="color:var(--text-secondary);font-size:14px;">데이터 로딩 중...</div>
                        </div>
                    </div>
                    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
                `;
                document.body.appendChild(loader);
            }
            if (loader) {
                loader.style.display = show ? 'block' : 'none';
            }
        }

        const getName = f => {
            if (!f) return '';
            if (typeof f === 'object') return f.name || '';
            return f.split(' ')[0];
        };
        const getAvatar = f => {
            if (!f) return '';
            const name = typeof f === 'object' ? (f.name || '') : f.split(' ')[0];
            return name.length >= 2 ? name.slice(-2) : name;
        };
        const getColorClass = p => p >= 80 ? 'high' : p < 50 ? 'low' : '';

        // D-day 계산
        function getDday(dueDate) {
            if (!dueDate) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getDdayText(dueDate) {
            const diff = getDday(dueDate);
            if (diff === null) return '';
            if (diff < 0) return `D+${Math.abs(diff)}`;
            if (diff === 0) return 'D-Day';
            return `D-${diff}`;
        }

        function getDdayClass(dueDate, progress) {
            if (progress === 100) return 'done';
            const diff = getDday(dueDate);
            if (diff === null) return 'normal';
            if (diff < 0) return 'overdue';
            if (diff <= 3) return 'urgent';
            return 'normal';
        }

        // 마지막 업데이트 시간 표시
        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            const month = lastUpdateTime.getMonth() + 1;
            const day = lastUpdateTime.getDate();
            const hours = lastUpdateTime.getHours();
            const minutes = lastUpdateTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('lastUpdateText').textContent =
                `${month}/${day} ${hours}:${minutes}`;
        }

        // 활동 로그 추가
        function addActivityLog(taskId, action, field, oldValue, newValue, taskName) {
            const log = {
                id: Date.now(),
                taskId,
                taskName,
                action,
                field,
                oldValue,
                newValue,
                createdAt: new Date().toISOString(),
                createdBy: CURRENT_USER
            };
            activityLogs.push(log);
            saveActivityLogs();
        }

        function saveActivityLogs() {
            localStorage.setItem('netform_activity_logs_v13', JSON.stringify(activityLogs));
        }

        function loadActivityLogs() {
            const saved = localStorage.getItem('netform_activity_logs_v13');
            if (saved) activityLogs = JSON.parse(saved);
        }

        // 프레젠테이션 모드
        function togglePresentation() {
            isPresentationMode = !isPresentationMode;
            document.querySelector('.app').classList.toggle('presentation-mode', isPresentationMode);
            if (isPresentationMode) {
                toast('📺 프레젠테이션 모드 활성화 (ESC로 종료)');
            }
        }

        // 기간 필터
        function updatePeriod() {
            const year = document.getElementById('yearFilter').value;
            const type = document.getElementById('periodType').value;
            const value = document.getElementById('periodValue').value;

            const periodSelect = document.getElementById('periodValue');

            if (type === 'quarter') {
                periodSelect.innerHTML = `
                    <option value="1">1분기</option>
                    <option value="2">2분기</option>
                    <option value="3">3분기</option>
                    <option value="4">4분기</option>
                `;
            } else {
                periodSelect.innerHTML = `
                    <option value="1">1월</option>
                    <option value="2">2월</option>
                    <option value="3">3월</option>
                    <option value="4">4월</option>
                    <option value="5">5월</option>
                    <option value="6">6월</option>
                    <option value="7">7월</option>
                    <option value="8">8월</option>
                    <option value="9">9월</option>
                    <option value="10">10월</option>
                    <option value="11">11월</option>
                    <option value="12">12월</option>
                `;
            }

            const periodLabel = type === 'quarter'
                ? `${year}년 ${value}분기 기준`
                : `${year}년 ${value}월 기준`;
            document.getElementById('periodLabel').textContent = periodLabel;
        }

        // 알림 배지가 있는 부서 확인
        function getDeptAlertStatus(deptId) {
            return false; // 느낌표 표시 비활성화
        }

        function renderNav() {
            document.getElementById('navDepts').innerHTML = ORG.departments.map(d => {
                return `
                    <div class="nav-item" onclick="showDetail('${d.id}')">
                        <span>${d.name}</span>
                    </div>
                `;
            }).join('');
        }

        function renderDeptGrid() {
            const colors = ['#3B82F6', '#06B6D4', '#10B981', '#EC4899', '#F59E0B', '#8B5CF6', '#6366F1'];
            
            // 부서별 통계 수집
            const deptStats = ORG.departments.map((d, idx) => {
                const st = getDeptStats(d.id);
                return {
                    id: d.id,
                    name: d.name,
                    leader: d.leader,
                    progress: st.mainKpiCount > 0 ? st.avg : 0,
                    kpiCount: st.mainKpiCount,
                    hasKpi: st.mainKpiCount > 0,
                    color: colors[idx % colors.length]
                };
            });

            // 전체 진척률은 상단 topCurrentPct에서 가져옴 (calcAll에서 계산됨)
            const totalAvg = parseInt(document.getElementById('topCurrentPct')?.textContent) || 0;

            // 도넛 세그먼트 계산 (전체 = 100%)
            const circumference = 565.48; // 2 * PI * 90
            const totalProgress = totalAvg;
            const progressOffset = circumference - (circumference * totalProgress / 100);

            // HTML 생성
            document.getElementById('deptGrid').innerHTML = `
                <div class="dept-unified-header">부서별 현황</div>
                <div class="dept-unified-content">
                    <div class="unified-donut-chart">
                        <svg class="unified-donut-svg" viewBox="0 0 200 200">
                            <circle class="unified-donut-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="unified-donut-segment" cx="100" cy="100" r="90" 
                                stroke="${colors[0]}"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${progressOffset}"
                                data-offset="${progressOffset}"></circle>
                        </svg>
                        <div class="unified-donut-center">
                            <div class="unified-donut-pct">${totalAvg}%</div>
                            <div class="unified-donut-label">전체 진척률</div>
                        </div>
                    </div>
                    <div class="unified-donut-legend">
                        ${deptStats.map(d => `
                            <div class="legend-item" onclick="showDetail('${d.id}')">
                                <div class="legend-left">
                                    <div class="legend-color" style="background: ${d.color}"></div>
                                    <span class="legend-name">${d.name}</span>
                                    <span class="legend-leader">${d.leader}</span>
                                </div>
                                <div class="legend-center">
                                    <div class="legend-progress-bar">
                                        <div class="legend-progress-fill" style="width: ${d.hasKpi ? d.progress : 0}%; background: ${d.color}"></div>
                                    </div>
                                </div>
                                <div class="legend-right">
                                    <span class="legend-pct" style="color: ${d.color}">${d.hasKpi ? d.progress + '%' : '-'}</span>
                                    <span class="legend-kpi">${d.hasKpi ? 'KPI ' + d.kpiCount + '개' : 'KPI 미설정'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // 도넛 애니메이션 적용
            setTimeout(animateUnifiedDonut, 100);
        }

        // 통합 도넛 애니메이션
        function animateUnifiedDonut() {
            const segment = document.querySelector('.unified-donut-segment');
            if (segment) {
                const targetOffset = parseFloat(segment.dataset.offset);
                segment.style.strokeDashoffset = 565.48; // 초기값 (circumference)
                setTimeout(() => {
                    segment.style.strokeDashoffset = targetOffset;
                }, 50);
            }
        }

        // 도넛 프로그레스 애니메이션 (기존 호환)
        function animateDonutProgress() {
            document.querySelectorAll('.dept-donut-progress').forEach(circle => {
                const targetOffset = parseFloat(circle.dataset.offset);
                circle.style.strokeDashoffset = 251.2; // 초기값
                setTimeout(() => {
                    circle.style.strokeDashoffset = targetOffset;
                }, 50);
            });
        }

        // 부서의 마지막 수정자 찾기 (KPI 기반)
        function getLastUpdaterForDept(deptId) {
            const d = ORG.departments.find(x => x.id === deptId);
            if (!d) return null;

            let lastUpdater = null;
            let lastTime = null;

            d.subDepts.forEach(s => {
                const kpi = kpiData[s.id];
                if (kpi && kpi.updated_at) {
                    const time = new Date(kpi.updated_at);
                    if (!lastTime || time > lastTime) {
                        lastTime = time;
                        lastUpdater = kpi.updated_by;
                    }
                }
            });

            return lastUpdater;
        }

        // 프로그레스 바 애니메이션 (기존 호환)
        function animateProgressBars() {
            document.querySelectorAll('.dept-bar-fill').forEach(bar => {
                const progress = bar.dataset.progress;
                setTimeout(() => {
                    bar.style.width = progress + '%';
                }, 50);
            });
        }

        // 숫자 카운트업 애니메이션
        function animateCountUp() {
            const elements = [
                { id: 'statProgress', suffix: '%' },
                { id: 'statDone', suffix: '' },
                { id: 'statTotal', suffix: '' },
                { id: 'statMembers', suffix: '' }
            ];

            elements.forEach(({ id, suffix }) => {
                const el = document.getElementById(id);
                const finalValue = parseInt(el.textContent);
                if (isNaN(finalValue)) return;

                let current = 0;
                const increment = finalValue / 30;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= finalValue) {
                        current = finalValue;
                        clearInterval(timer);
                    }
                    el.textContent = Math.round(current) + suffix;
                }, 30);
            });
        }

        // 부서 통계 (KPI 기반)
        function getDeptStats(deptId) {
            const d = ORG.departments.find(x => x.id === deptId);
            if (!d) return { avg: 0, mainKpiCount: 0, members: 0 };
            
            let totalProgress = 0;
            let teamsWithKpi = 0;
            let totalMainKpis = 0;

            d.subDepts.forEach(s => {
                const progress = calculateTeamProgress(s.id);
                if (progress !== null) {
                    totalProgress += progress;
                    teamsWithKpi++;
                    
                    const kpi = kpiData[s.id];
                    if (kpi && kpi.mainMetrics) {
                        totalMainKpis += kpi.mainMetrics.length;
                    }
                }
            });

            return { 
                avg: teamsWithKpi ? Math.round(totalProgress / teamsWithKpi) : 0, 
                mainKpiCount: totalMainKpis, 
                members: d.headcount 
            };
        }

        function calcAll() {
            // KPI 기반 진척률 계산
            const deptData = [];
            let teamsWithKpi = 0;
            let totalMainKpis = 0;
            let activeMainKpis = 0; // 50% 이상 KPI
            let delayedMainKpis = 0; // 50% 미만 KPI

            ORG.departments.forEach(d => {
                let deptProgress = 0;
                let deptTeamsWithKpi = 0;

                d.subDepts.forEach(s => {
                    const progress = calculateTeamProgress(s.id);
                    if (progress !== null) {
                        deptProgress += progress;
                        deptTeamsWithKpi++;
                        teamsWithKpi++;

                        // 메인 KPI 활성화/지연 카운트
                        const kpi = kpiData[s.id];
                        if (kpi && kpi.mainMetrics) {
                            kpi.mainMetrics.forEach(m => {
                                totalMainKpis++;
                                const current = parseFloat(m.value) || 0;
                                const target = parseFloat(m.target) || 1;
                                const pct = Math.round((current / target) * 100);
                                if (pct >= 50) activeMainKpis++;
                                else delayedMainKpis++;
                            });
                        }
                    }
                });

                // 부서별 평균 (KPI 있는 팀들만)
                deptData.push(deptTeamsWithKpi ? Math.round(deptProgress / deptTeamsWithKpi) : 0);
            });

            // 전사 평균 진척률
            const companyProgress = calculateCompanyProgress();

            // 참여 인원 (KPI 설정된 팀의 멤버 수)
            let totalMembers = 0;
            ORG.departments.forEach(d => {
                d.subDepts.forEach(s => {
                    if (kpiData[s.id] && kpiData[s.id].mainMetrics && kpiData[s.id].mainMetrics.length > 0) {
                        totalMembers += s.members.length;
                    }
                });
            });

            // 마감일 계산 (2026년 12월 31일)
            const deadline = new Date('2026-12-31');
            const today = new Date();
            const diffTime = deadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // 통계 업데이트
            document.getElementById('statDeadline').textContent = 'D-' + diffDays;
            document.getElementById('statDelayed').textContent = delayedMainKpis;
            document.getElementById('statDone').textContent = activeMainKpis;
            document.getElementById('statTotal').textContent = totalMainKpis;
            document.getElementById('statMembers').textContent = totalMembers;

            // 상단 슬로건 바 업데이트
            const goalRatio = Math.min((companyProgress / GOAL_TARGET) * 100, 100);
            document.getElementById('topCurrentPct').textContent = companyProgress + '%';
            document.getElementById('topProgressFill').style.width = goalRatio + '%';
            document.getElementById('topProgressText').textContent = companyProgress + '% 달성';

            renderDeptGrid();
            renderNav();
        }

        function renderWinners(stats) {
            const el = document.getElementById('winnersGrid');
            if (!el) return; // 요소가 없으면 종료
            
            const list = Object.values(stats);
            list.forEach(m => m.avg = m.count ? Math.round(m.total / m.count) : 0);
            list.sort((a, b) => b.avg - a.avg);
            const top3 = list.slice(0, 3);

            if (top3.length < 3) {
                el.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-text">업무를 등록하면 표시됩니다</div></div>';
                return;
            }

            const ranks = ['gold', 'silver', 'bronze'];
            el.innerHTML = top3.map((m, i) => `
                <div class="winner-card ${ranks[i]}">
                    <div class="winner-rank">${i + 1}</div>
                    <div class="winner-avatar">${getAvatar(m.name)}</div>
                    <div class="winner-name">${getName(m.name)}</div>
                    <div class="winner-dept">${m.dept}</div>
                    <div class="winner-score">${m.avg}%</div>
                    <div class="winner-score-label">평균 진척률</div>
                </div>
            `).join('');
        }

        function initCharts() {
            // 차트 영역 제거됨 - 함수 유지 (호환성)
        }

        function goMain() {
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('detailPage').classList.remove('active');
            document.querySelectorAll('.nav-item').forEach((el, i) => el.classList.toggle('active', i === 0));
            curDept = curSub = null;
            calcAll();
            
            // 페이지 맨 위로 스크롤 (모바일 대응)
            window.scrollTo(0, 0);
            document.querySelector('.main')?.scrollTo(0, 0);
        }

        async function showDetail(deptId, subId = null) {
            const d = ORG.departments.find(x => x.id === deptId);
            if (!d) return;
            curDept = deptId; curSub = subId || d.subDepts[0]?.id;

            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('detailPage').classList.add('active');
            document.getElementById('detailTitle').textContent = d.name;
            document.getElementById('detailSubtitle').textContent = d.leaderFull || d.leader;

            // 본부 전체 통계 (메인 KPI 기반)
            const st = getDeptStats(deptId);
            document.getElementById('detailProgress').textContent = st.mainKpiCount > 0 ? st.avg + '%' : '-';
            document.getElementById('detailMembers').textContent = d.headcount;

            document.querySelectorAll('.nav-item').forEach((el, i) => el.classList.toggle('active', i === ORG.departments.findIndex(x => x.id === deptId) + 1));

            renderTabs(d); 
            updateTeamProgressBar(); // 선택된 팀 진척률 업데이트
            renderKpiSection(); 
            await loadAndRenderInitiatives();
            
            // 페이지 맨 위로 스크롤 (모바일 대응)
            window.scrollTo(0, 0);
            document.querySelector('.main')?.scrollTo(0, 0);
        }

        // 선택된 팀 진척률 바 업데이트
        function updateTeamProgressBar() {
            if (!curSub) return;

            // 팀 이름 찾기
            let teamName = '';
            let teamMembers = 0;
            ORG.departments.forEach(d => {
                const sub = d.subDepts.find(s => s.id === curSub);
                if (sub) {
                    teamName = sub.name;
                    teamMembers = sub.members.length;
                }
            });

            // 팀 진척률 계산
            const progress = calculateTeamProgress(curSub);
            const kpi = kpiData[curSub];
            const mainKpiCount = kpi && kpi.mainMetrics ? kpi.mainMetrics.length : 0;

            document.getElementById('teamProgressName').textContent = teamName;
            document.getElementById('teamProgressValue').textContent = progress !== null ? progress + '%' : '-';
            document.getElementById('teamProgressMembers').textContent = teamMembers;
            document.getElementById('teamProgressKpi').textContent = mainKpiCount > 0 ? `메인 KPI ${mainKpiCount}개` : 'KPI 미설정';
        }

        // Initiative 로드 및 렌더링
        // Initiative 로드 및 렌더링
        async function loadAndRenderInitiatives() {
            // 팀별 텍스트 설정
            updateSectionLabels();
            
            console.log('📋 Initiative 로드 시작 - curSub:', curSub);
            
            if (supabaseClient && curSub) {
                await loadInitiatives();
                console.log('📋 Initiative 데이터:', initiativeData);
                renderInitiatives();
            } else {
                console.log('❌ Supabase 또는 curSub 없음:', { supabaseClient: !!supabaseClient, curSub });
            }
        }

        // 팀별 섹션 라벨 업데이트
        function updateSectionLabels() {
            const isGrowth = curSub === 'growth';
            const title = isGrowth ? '📋 Initiative 현황' : '🎯 핵심 과제 현황';
            const addBtn = isGrowth ? '+ Initiative 추가' : '+ 핵심 과제 추가';
            const nameLabel = isGrowth ? 'Initiative 이름 *' : '과제명 *';
            
            document.getElementById('initSectionTitle').textContent = title;
            document.getElementById('initAddBtn').textContent = addBtn;
            document.getElementById('initNameLabel').textContent = nameLabel;
        }

        // 용어 가져오기 (그로스팀 vs 다른팀)
        function getTermLabel(type) {
            const isGrowth = curSub === 'growth';
            const terms = {
                title: isGrowth ? 'Initiative' : '핵심 과제',
                add: isGrowth ? 'Initiative 추가' : '핵심 과제 추가',
                edit: isGrowth ? 'Initiative 수정' : '핵심 과제 수정',
                name: isGrowth ? 'Initiative 이름' : '과제명',
                empty: isGrowth ? 'Initiative가' : '핵심 과제가'
            };
            return terms[type] || terms.title;
        }

        function renderTabs(d) {
            document.getElementById('tabs').innerHTML = d.subDepts.map(s =>
                `<button class="tab ${s.id === curSub ? 'active' : ''}" onclick="switchSub('${s.id}', this)">${s.name}</button>`
            ).join('');
        }

        async function switchSub(subId, el) {
            curSub = subId;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            updateTeamProgressBar(); // 선택된 팀 진척률 업데이트
            renderKpiSection(); 
            await loadAndRenderInitiatives();
        }

        function renderMembers(deptId) {
            const d = ORG.departments.find(x => x.id === deptId);
            const currentSub = d.subDepts.find(s => s.id === curSub);
            if (!currentSub) return;

            const stats = {};
            currentSub.members.forEach(m => {
                // 문자열인 경우 그대로 사용, 객체인 경우 name + role 조합
                const memberKey = typeof m === 'string' ? m : `${m.name} ${m.role}`;
                const memberName = typeof m === 'string' ? m : `${m.name} ${m.role}`;
                stats[memberKey] = { name: memberName, sub: currentSub.name, total: 0, count: 0 };
            });
            (taskData[curSub] || []).forEach(t => {
                if (t.assignee && stats[t.assignee]) {
                    stats[t.assignee].total += t.progress;
                    stats[t.assignee].count++;
                }
            });

            const list = Object.values(stats);
            list.forEach(m => m.avg = m.count ? Math.round(m.total / m.count) : 0);

            document.getElementById('memberGrid').innerHTML = list.length ? list.map(m => `
                <div class="member-card" onclick="showModal('${m.name}','${deptId}')">
                    <div class="member-avatar">${getAvatar(m.name)}</div>
                    <div class="member-info">
                        <div class="member-name">${getName(m.name)}</div>
                        <div class="member-role">${m.sub}</div>
                    </div>
                    <div class="member-right">
                        <div class="member-pct">${m.count ? m.avg + '%' : '-'}</div>
                        <div class="member-cnt">${m.count}건</div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state" style="grid-column:1/-1"><div class="empty-text">팀원이 없습니다</div></div>';
        }

        function showModal(name, deptId) {
            const d = ORG.departments.find(x => x.id === deptId);
            const tasks = [];
            ORG.departments.forEach(dept => dept.subDepts.forEach(s => (taskData[s.id] || []).forEach(t => { if (t.assignee === name) tasks.push({ ...t, sub: s.name }); })));

            const total = tasks.reduce((sum, t) => sum + t.progress, 0);
            const avg = tasks.length ? Math.round(total / tasks.length) : 0;

            document.getElementById('modalAvatar').textContent = getAvatar(name);
            document.getElementById('modalName').textContent = getName(name);
            document.getElementById('modalDept').textContent = d.name;
            document.getElementById('modalProgress').textContent = avg + '%';
            document.getElementById('modalTasks').textContent = tasks.length;
            document.getElementById('modalDone').textContent = tasks.filter(t => t.progress === 100).length;
            document.getElementById('modalBody').innerHTML = tasks.length ? tasks.map(t => `
                <div class="modal-task">
                    <div><div class="modal-task-name">${t.name}</div><div class="modal-task-sub">${t.sub}</div></div>
                    <div class="modal-task-pct">${t.progress}%</div>
                </div>
            `).join('') : '<div class="empty-state"><div class="empty-text">담당 업무가 없습니다</div></div>';

            document.getElementById('modal').classList.add('show');
        }

        function closeModal() { document.getElementById('modal').classList.remove('show'); }
        document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });

        // 변경 이력 모달
        function showHistoryModal(taskIndex) {
            const task = taskData[curSub]?.[taskIndex];
            if (!task) return;

            const taskId = `${curSub}_${taskIndex}`;
            const logs = activityLogs.filter(log => log.taskId === taskId);

            document.getElementById('historyTaskName').textContent = task.name;
            document.getElementById('historyBody').innerHTML = logs.length ? logs.reverse().map(log => {
                const date = new Date(log.createdAt);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-action">${log.action}</span>
                            <span class="history-date">${dateStr}</span>
                        </div>
                        ${log.field ? `<div class="history-detail">${log.field}: ${log.oldValue || '-'} → ${log.newValue || '-'}</div>` : ''}
                        <div class="history-by">${log.createdBy}</div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><div class="empty-text">변경 이력이 없습니다</div></div>';

            document.getElementById('historyModal').classList.add('show');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        document.getElementById('historyModal').addEventListener('click', e => {
            if (e.target.id === 'historyModal') closeHistoryModal();
        });

        function renderTasks() {
            if (!curSub) return;
            const tasks = taskData[curSub] || [];
            updateAssignees();

            const d = ORG.departments.find(x => x.id === curDept);
            const s = d?.subDepts.find(x => x.id === curSub);
            const rawMembers = s?.members || [];
            // 문자열/객체 둘 다 처리
            const members = rawMembers.map(m => typeof m === 'string' ? m : `${m.name} ${m.role}`);

            document.getElementById('taskList').innerHTML = tasks.length ? tasks.map((t, i) => {
                const isEdit = editIdx === i;
                const ddayText = getDdayText(t.dueDate);
                const ddayClass = getDdayClass(t.dueDate, t.progress);
                const hasPriority = t.priority && t.priority !== '';
                return `
                    <div class="task-item ${hasPriority ? 'has-priority' : ''}">
                        ${hasPriority ? `<div class="priority-bar ${t.priority}"></div>` : ''}
                        <div class="task-name">
                            <span class="${isEdit ? 'hide' : ''}">${t.name}</span>
                            <input type="text" class="${isEdit ? 'show' : ''}" value="${t.name}" id="editInput_${i}" onkeypress="if(event.key==='Enter')saveEdit(${i})">
                        </div>
                        ${ddayText ? `<span class="task-dday ${ddayClass}">${ddayText}</span>` : ''}
                        ${t.updatedBy ? `<span class="task-updated-by">${getName(t.updatedBy)} 수정</span>` : ''}
                        <select class="task-select" onchange="updateTask(${i},'assignee',this.value)">
                            <option value="">담당자</option>
                            ${members.map(m => `<option value="${m}" ${t.assignee===m?'selected':''}>${getName(m)}</option>`).join('')}
                        </select>
                        <select class="task-select" onchange="updateTask(${i},'progress',this.value)">
                            ${[0,10,20,30,40,50,60,70,80,90,100].map(p => `<option value="${p}" ${t.progress===p?'selected':''}>${p}%</option>`).join('')}
                        </select>
                        <select class="task-select" onchange="updateTask(${i},'priority',this.value)">
                            <option value="" ${!t.priority?'selected':''}>우선순위</option>
                            <option value="high" ${t.priority==='high'?'selected':''}>상</option>
                            <option value="medium" ${t.priority==='medium'?'selected':''}>중</option>
                            <option value="low" ${t.priority==='low'?'selected':''}>하</option>
                        </select>
                        <input type="date" class="task-select" value="${t.dueDate || ''}" onchange="updateTask(${i},'dueDate',this.value)" style="width:140px">
                        <div class="task-actions">
                            ${isEdit ? `
                                <button class="btn-xs btn-edit" onclick="saveEdit(${i})">저장</button>
                                <button class="btn-xs btn-del" onclick="cancelEdit()">취소</button>
                            ` : `
                                <button class="btn-xs btn-edit" onclick="startEdit(${i})">수정</button>
                                <button class="btn-xs btn-history" onclick="showHistoryModal(${i})">이력</button>
                                <button class="btn-xs btn-del" onclick="deleteTask(${i})">삭제</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><div class="empty-text">등록된 업무가 없습니다</div></div>';
        }

        function updateAssignees() {
            const d = ORG.departments.find(x => x.id === curDept);
            const s = d?.subDepts.find(x => x.id === curSub);
            const sel = document.getElementById('newAssignee');
            if (sel) sel.innerHTML = '<option value="">담당자</option>' + (s?.members || []).map(m => {
                const memberVal = typeof m === 'string' ? m : `${m.name} ${m.role}`;
                return `<option value="${memberVal}">${getName(memberVal)}</option>`;
            }).join('');
        }

        function showTaskForm() { document.getElementById('taskForm').classList.add('show'); document.getElementById('newName').focus(); }
        function hideTaskForm() {
            document.getElementById('taskForm').classList.remove('show');
            document.getElementById('newName').value = '';
            document.getElementById('newAssignee').value = '';
            document.getElementById('newProgress').value = '0';
            document.getElementById('newPriority').value = '';
            document.getElementById('newDueDate').value = '';
        }

        async function addTask() {
            const name = document.getElementById('newName').value.trim();
            if (!name) return alert('업무명을 입력하세요');

            const newTask = {
                name,
                assignee: document.getElementById('newAssignee').value,
                progress: parseInt(document.getElementById('newProgress').value),
                priority: document.getElementById('newPriority').value,
                dueDate: document.getElementById('newDueDate').value
            };

            if (supabaseClient && SupabaseConfig.enabled) {
                // Supabase에 저장
                const result = await createTaskInSupabase(curSub, newTask);
                if (result) {
                    await loadTasksFromSupabase();
                }
            } else {
                // localStorage에 저장
                if (!taskData[curSub]) taskData[curSub] = [];
                const now = new Date().toISOString();
                newTask.createdAt = now;
                newTask.updatedAt = now;
                newTask.updatedBy = CURRENT_USER;
                taskData[curSub].push(newTask);
                saveData();
            }

            renderTasks();
            renderMembers(curDept);
            updateDetail();
            calcAll();
            hideTaskForm();
            updateLastUpdateTime();
            toast('✅ 업무가 등록되었습니다');
        }

        async function updateTask(i, field, val) {
            if (taskData[curSub]?.[i]) {
                const task = taskData[curSub][i];
                const oldValue = task[field];
                const newValue = field === 'progress' ? parseInt(val) : val;

                if (supabaseClient && SupabaseConfig.enabled && task.id) {
                    // Supabase 업데이트
                    const updates = { [field]: newValue };
                    await updateTaskInSupabase(task.id, updates, task);
                    await loadTasksFromSupabase();
                } else {
                    // localStorage 업데이트
                    task[field] = newValue;
                    task.updatedAt = new Date().toISOString();
                    task.updatedBy = CURRENT_USER;
                    saveData();
                }

                renderTasks();
                renderMembers(curDept);
                updateDetail();
                calcAll();
                updateLastUpdateTime();
            }
        }

        function startEdit(i) { editIdx = i; renderTasks(); setTimeout(() => { const inp = document.getElementById(`editInput_${i}`); if (inp) { inp.focus(); inp.select(); } }, 50); }

        async function saveEdit(i) {
            const inp = document.getElementById(`editInput_${i}`);
            if (inp?.value.trim() && taskData[curSub]?.[i]) {
                const task = taskData[curSub][i];
                const oldName = task.name;
                const newName = inp.value.trim();

                if (supabaseClient && SupabaseConfig.enabled && task.id) {
                    await updateTaskInSupabase(task.id, { name: newName }, task);
                    await loadTasksFromSupabase();
                } else {
                    task.name = newName;
                    task.updatedAt = new Date().toISOString();
                    task.updatedBy = CURRENT_USER;
                    saveData();
                }

                updateLastUpdateTime();
                toast('✏️ 수정되었습니다');
            }
            editIdx = null;
            renderTasks();
        }

        function cancelEdit() { editIdx = null; renderTasks(); }

        async function deleteTask(i) {
            if (confirm('삭제하시겠습니까?')) {
                const task = taskData[curSub][i];

                if (supabaseClient && SupabaseConfig.enabled && task.id) {
                    await deleteTaskInSupabase(task.id, task.name);
                    await loadTasksFromSupabase();
                } else {
                    taskData[curSub].splice(i, 1);
                    saveData();
                }

                renderTasks();
                renderMembers(curDept);
                updateDetail();
                calcAll();
                updateLastUpdateTime();
                toast('🗑️ 삭제되었습니다');
            }
        }

        function updateDetail() {
            const d = ORG.departments.find(x => x.id === curDept);
            if (!d) return;
            
            const st = getDeptStats(curDept);
            document.getElementById('detailProgress').textContent = st.mainKpiCount > 0 ? st.avg + '%' : '-';
            document.getElementById('detailMembers').textContent = d.headcount;
            updateTeamProgressBar();
        }

        function saveData() { localStorage.setItem('netform_kpi_v13', JSON.stringify(taskData)); }
        function loadData() {
            const saved = localStorage.getItem('netform_kpi_v13');
            if (saved) taskData = JSON.parse(saved);
            loadActivityLogs();
        }
        function saveAll() { saveData(); updateLastUpdateTime(); toast('✅ 저장되었습니다'); }

        function exportData() {
            const blob = new Blob([JSON.stringify({
                company: '넷폼알앤디',
                version: 'v13',
                date: new Date().toISOString(),
                tasks: taskData,
                activityLogs: activityLogs
            }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `넷폼알앤디_KPI_${new Date().toISOString().split('T')[0]}.json`; a.click();
            toast('📤 JSON 내보내기 완료');
        }

        // 엑셀 다운로드
        function exportToExcel() {
            const workbook = XLSX.utils.book_new();

            // 전체 요약 시트
            const summaryData = [
                ['넷폼알앤디 KPI 대시보드'],
                ['생성일시', new Date().toLocaleString('ko-KR')],
                [''],
                ['부서명', '리더', '진척률', '업무 수', '인원']
            ];

            ORG.departments.forEach(d => {
                const st = getDeptStats(d.id);
                summaryData.push([d.name, d.leader, st.avg + '%', st.count, d.headcount]);
            });

            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, '전체 요약');

            // 부서별 상세 시트
            ORG.departments.forEach(d => {
                const sheetData = [
                    [d.name + ' 업무 현황'],
                    [''],
                    ['업무명', '담당자', '진척률', '우선순위', '마감일', '수정자', '수정일시']
                ];

                d.subDepts.forEach(s => {
                    (taskData[s.id] || []).forEach(t => {
                        const priorityMap = { high: '상', medium: '중', low: '하' };
                        sheetData.push([
                            t.name,
                            t.assignee || '-',
                            t.progress + '%',
                            priorityMap[t.priority] || '-',
                            t.dueDate || '-',
                            t.updatedBy || '-',
                            t.updatedAt ? new Date(t.updatedAt).toLocaleString('ko-KR') : '-'
                        ]);
                    });
                });

                const sheet = XLSX.utils.aoa_to_sheet(sheetData);
                const sheetName = d.name.substring(0, 31).replace(/[\/\\?*\[\]]/g, '');
                XLSX.utils.book_append_sheet(workbook, sheet, sheetName);
            });

            // 다운로드
            XLSX.writeFile(workbook, `넷폼알앤디_KPI_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('📊 엑셀 다운로드 완료');
        }

        function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2500); }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (isPresentationMode) {
                    togglePresentation();
                    return;
                }
                if (editIdx !== null) cancelEdit();
                closeModal();
                closeHistoryModal();
                closeKpiModal();
                hideTaskForm();
            }
        });

        // 다크모드 토글
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';

            if (isDark) {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }

            updateChartColors();
        }

        function updateChartColors() {
            // 차트 영역 제거됨 - 함수 유지 (호환성)
        }

        // 초기 테마 로드
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        // ========== KPI 관련 함수 ==========

        // KPI 데이터 로드
        function loadKpiData() {
            const saved = localStorage.getItem('netform_kpi_data_v13');
            if (saved) {
                kpiData = JSON.parse(saved);
            } else {
                // 기본 데이터로 초기화
                kpiData = { ...DEFAULT_KPI_DATA };
                saveKpiDataToStorage();
            }
        }

        // KPI 데이터 저장
        function saveKpiDataToStorage() {
            localStorage.setItem('netform_kpi_data_v13', JSON.stringify(kpiData));
        }

        // KPI 섹션 렌더링
        function renderKpiSection() {
            if (!curSub) return;

            const kpi = kpiData[curSub];
            const contentEl = document.getElementById('kpiContent');
            const editBtn = document.getElementById('kpiEditBtn');
            const detailLink = document.getElementById('kpiDetailLink');

            // 현재 팀 이름 찾기
            let teamName = '';
            ORG.departments.forEach(d => {
                const sub = d.subDepts.find(s => s.id === curSub);
                if (sub) teamName = sub.name;
            });

            // 권한 체크
            const canEdit = canEditTeam(curSub);
            const isAdmin = currentUser && currentUser.isAdmin;

            // 대시보드 상세보기 버튼 (관리자만 + 링크 있을 때만)
            const dashboardUrl = kpi?.dashboardUrl || '';
            
            if (isAdmin && dashboardUrl) {
                detailLink.href = dashboardUrl;
                detailLink.style.display = 'inline-flex';
            } else {
                detailLink.style.display = 'none';
            }

            if (!kpi || !kpi.mission) {
                // KPI가 없는 경우
                editBtn.style.display = 'none';
                contentEl.innerHTML = `
                    <div class="kpi-empty">
                        <div class="kpi-empty-icon">📊</div>
                        <div class="kpi-empty-text">아직 KPI가 등록되지 않았습니다</div>
                        ${canEdit ? '<button class="btn-kpi-add" onclick="openKpiModal()">+ KPI 등록하기</button>' : '<div style="color:var(--text-tertiary);font-size:13px;margin-top:8px;">KPI 등록은 해당 팀 로그인 후 가능합니다</div>'}
                    </div>
                `;
            } else {
                // KPI가 있는 경우
                editBtn.style.display = canEdit ? 'block' : 'none';

                let html = '';

                // 미션 카드 (필수)
                html += `
                    <div class="kpi-mission">
                        <div class="kpi-mission-label">팀 미션</div>
                        <div class="kpi-mission-text">${kpi.mission}</div>
                    </div>
                `;

                // 메인 KPI (진척률 반영) - 카드형
                if (kpi.mainMetrics && kpi.mainMetrics.length > 0) {
                    // 진척률 계산
                    const progressList = kpi.mainMetrics.map(m => {
                        const current = parseFloat(m.value) || 0;
                        const target = parseFloat(m.target) || 1;
                        return Math.min(Math.round((current / target) * 100), 100);
                    });
                    const avgProgress = progressList.length > 0 
                        ? Math.round(progressList.reduce((a, b) => a + b, 0) / progressList.length) 
                        : 0;

                    html += '<div class="kpi-main-section">';
                    html += '<div class="kpi-metrics-grid">';
                    kpi.mainMetrics.forEach((m, i) => {
                        const progress = progressList[i];
                        const progressColor = progress >= 80 ? 'var(--green)' : progress >= 50 ? 'var(--orange)' : 'var(--blue)';
                        html += `
                            <div class="kpi-metric-card main">
                                <div class="kpi-metric-progress" style="color:${progressColor}">${progress}%</div>
                                <div class="kpi-metric-label">${m.label}</div>
                                <div class="kpi-metric-detail">${m.value}/${m.target}${m.unit}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += `<div class="kpi-team-progress">📊 팀 평균 진척률: <strong>${avgProgress}%</strong></div>`;
                    html += '</div>';
                }

                // 서브 KPI (참고용) - 리스트형
                if (kpi.subMetrics && kpi.subMetrics.length > 0) {
                    html += `<div class="kpi-sub-section">`;
                    html += `<div class="kpi-sub-title">📋 참고 지표</div>`;
                    html += `<div class="kpi-sub-list">`;
                    kpi.subMetrics.forEach(m => {
                        html += `<div class="kpi-sub-item">• ${m.label}: <strong>${m.value}${m.unit}</strong></div>`;
                    });
                    html += '</div></div>';
                }

                // 레거시 metrics 표시 (mainMetrics/subMetrics 없고 metrics만 있는 경우)
                if ((!kpi.mainMetrics || kpi.mainMetrics.length === 0) && 
                    (!kpi.subMetrics || kpi.subMetrics.length === 0) && 
                    kpi.metrics && kpi.metrics.length > 0) {
                    html += '<div class="kpi-metrics-grid">';
                    kpi.metrics.forEach(m => {
                        html += `
                            <div class="kpi-metric-card">
                                <div>
                                    <span class="kpi-metric-value">${m.value}</span>
                                    <span class="kpi-metric-unit">${m.unit}</span>
                                </div>
                                <div class="kpi-metric-label">${m.label}</div>
                                ${m.period ? `<div class="kpi-metric-period">${m.period}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // 조건 리스트 (있으면 표시)
                if (kpi.conditions && kpi.conditions.length > 0) {
                    const isGrowth = curSub === 'growth';
                    const conditionTitle = isGrowth ? '이니셔티브 선정 조건' : 'KPI 선정 조건';
                    html += `
                        <div class="kpi-conditions">
                            <div class="kpi-conditions-title">${conditionTitle}</div>
                    `;
                    kpi.conditions.forEach(c => {
                        html += `
                            <div class="kpi-condition-item">
                                <div class="kpi-condition-bullet"></div>
                                <div class="kpi-condition-text">${c}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                contentEl.innerHTML = html;
            }
        }

        // 팀 진척률 계산 함수
        function calculateTeamProgress(subDeptId) {
            const kpi = kpiData[subDeptId];
            if (!kpi || !kpi.mainMetrics || kpi.mainMetrics.length === 0) {
                return null; // KPI 미설정
            }

            const progressList = kpi.mainMetrics.map(m => {
                const current = parseFloat(m.value) || 0;
                const target = parseFloat(m.target) || 1;
                return Math.min(Math.round((current / target) * 100), 100);
            });

            return Math.round(progressList.reduce((a, b) => a + b, 0) / progressList.length);
        }

        // 전사 진척률 계산 함수
        function calculateCompanyProgress() {
            const teamProgresses = [];
            
            ORG.departments.forEach(dept => {
                dept.subDepts.forEach(sub => {
                    const progress = calculateTeamProgress(sub.id);
                    if (progress !== null) {
                        teamProgresses.push(progress);
                    }
                });
            });

            if (teamProgresses.length === 0) return 0;
            return Math.round(teamProgresses.reduce((a, b) => a + b, 0) / teamProgresses.length);
        }

        // KPI 모달 열기
        function openKpiModal() {
            const kpi = kpiData[curSub] || { mission: '', mainMetrics: [], subMetrics: [], conditions: [] };

            // 팀 이름 찾기
            let teamName = '';
            ORG.departments.forEach(d => {
                const sub = d.subDepts.find(s => s.id === curSub);
                if (sub) teamName = sub.name;
            });

            document.getElementById('kpiModalSubtitle').textContent = teamName;
            document.getElementById('kpiMissionInput').value = kpi.mission || '';

            // 조건 설명 텍스트 (그로스팀만 이니셔티브)
            const isGrowth = curSub === 'growth';
            document.getElementById('kpiConditionsDesc').textContent = isGrowth 
                ? '이니셔티브 선정 기준이나 조건을 설정합니다 (선택)' 
                : 'KPI 선정 기준이나 조건을 설정합니다 (선택)';

            // 메인 KPI 체크박스 및 필드
            const hasMainMetrics = kpi.mainMetrics && kpi.mainMetrics.length > 0;
            document.getElementById('kpiMainMetricsToggle').checked = hasMainMetrics;
            document.getElementById('kpiMainMetricsItems').style.display = hasMainMetrics ? 'block' : 'none';
            renderMainMetricFields(kpi.mainMetrics || []);

            // 서브 KPI 체크박스 및 필드
            const hasSubMetrics = kpi.subMetrics && kpi.subMetrics.length > 0;
            document.getElementById('kpiSubMetricsToggle').checked = hasSubMetrics;
            document.getElementById('kpiSubMetricsItems').style.display = hasSubMetrics ? 'block' : 'none';
            renderSubMetricFields(kpi.subMetrics || []);

            // 조건 체크박스 및 필드
            const hasConditions = kpi.conditions && kpi.conditions.length > 0;
            document.getElementById('kpiConditionsToggle').checked = hasConditions;
            document.getElementById('kpiConditionsItems').classList.toggle('show', hasConditions);
            renderConditionFields(kpi.conditions || []);

            // 대시보드 링크 섹션 (관리자만 표시)
            const isAdmin = currentUser && currentUser.isAdmin;
            const linkSection = document.getElementById('kpiDashboardLinkSection');
            if (isAdmin) {
                linkSection.style.display = 'block';
                document.getElementById('kpiDashboardUrlInput').value = kpi.dashboardUrl || '';
            } else {
                linkSection.style.display = 'none';
            }

            document.getElementById('kpiModal').classList.add('show');
        }

        // KPI 모달 닫기
        function closeKpiModal() {
            document.getElementById('kpiModal').classList.remove('show');
        }

        // 메인 KPI 토글
        function toggleKpiMainMetrics() {
            const checked = document.getElementById('kpiMainMetricsToggle').checked;
            document.getElementById('kpiMainMetricsItems').style.display = checked ? 'block' : 'none';
            if (checked && document.getElementById('kpiMainMetricsList').children.length === 0) {
                addMainMetricField();
            }
        }

        // 서브 KPI 토글
        function toggleKpiSubMetrics() {
            const checked = document.getElementById('kpiSubMetricsToggle').checked;
            document.getElementById('kpiSubMetricsItems').style.display = checked ? 'block' : 'none';
            if (checked && document.getElementById('kpiSubMetricsList').children.length === 0) {
                addSubMetricField();
            }
        }

        // 조건 토글
        function toggleKpiConditions() {
            const checked = document.getElementById('kpiConditionsToggle').checked;
            document.getElementById('kpiConditionsItems').classList.toggle('show', checked);
            if (checked && document.getElementById('kpiConditionsList').children.length === 0) {
                addConditionField();
            }
        }

        // 메인 KPI 필드 렌더링
        function renderMainMetricFields(metrics) {
            const container = document.getElementById('kpiMainMetricsList');
            container.innerHTML = '';
            if (metrics && metrics.length > 0) {
                metrics.forEach(m => {
                    addMainMetricField(m.label, m.value, m.unit, m.target);
                });
            }
        }

        // 서브 KPI 필드 렌더링
        function renderSubMetricFields(metrics) {
            const container = document.getElementById('kpiSubMetricsList');
            container.innerHTML = '';
            if (metrics && metrics.length > 0) {
                metrics.forEach(m => {
                    addSubMetricField(m.label, m.value, m.unit, m.target || '');
                });
            }
        }

        // 메인 KPI 필드 추가 (지표명, 현재값, 단위, 목표값)
        function addMainMetricField(label = '', value = '', unit = '', target = '') {
            const container = document.getElementById('kpiMainMetricsList');
            const div = document.createElement('div');
            div.className = 'kpi-form-item';
            div.innerHTML = `
                <input type="text" placeholder="지표명" value="${label}">
                <input type="text" class="small" placeholder="현재값" value="${value}">
                <input type="text" class="small" placeholder="단위" value="${unit}">
                <div class="target-input">
                    <span class="target-prefix">목표</span>
                    <input type="text" class="small" placeholder="목표값" value="${target}">
                </div>
                <button class="btn-remove-item" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(div);
        }

        // 서브 KPI 필드 추가 (지표명, 값, 단위만)
        function addSubMetricField(label = '', value = '', unit = '', target = '') {
            const container = document.getElementById('kpiSubMetricsList');
            const div = document.createElement('div');
            div.className = 'kpi-form-item sub';
            div.innerHTML = `
                <input type="text" placeholder="지표명" value="${label}">
                <input type="text" class="small" placeholder="값" value="${value}">
                <input type="text" class="small" placeholder="단위" value="${unit}">
                <div class="target-input">
                    <span class="target-prefix">목표</span>
                    <input type="text" class="small" placeholder="목표값" value="${target}">
                </div>
                <button class="btn-remove-item" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(div);
        }

        // 조건 필드 렌더링
        function renderConditionFields(conditions) {
            const container = document.getElementById('kpiConditionsList');
            container.innerHTML = '';
            if (conditions.length === 0) {
                addConditionField();
            } else {
                conditions.forEach(c => {
                    addConditionField(c);
                });
            }
        }

        // 조건 필드 추가
        function addConditionField(text = '') {
            const container = document.getElementById('kpiConditionsList');
            const div = document.createElement('div');
            div.className = 'kpi-form-condition';
            div.innerHTML = `
                <textarea placeholder="조건을 입력하세요...">${text}</textarea>
                <button class="btn-remove-item" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(div);
        }

        // KPI 데이터 저장
        async function saveKpiData() {
            const mission = document.getElementById('kpiMissionInput').value.trim();

            if (!mission) {
                alert('팀 미션은 필수 입력 항목입니다.');
                return;
            }

            // 메인 KPI 수집
            const mainMetrics = [];
            if (document.getElementById('kpiMainMetricsToggle').checked) {
                document.querySelectorAll('#kpiMainMetricsList .kpi-form-item').forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const label = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    const unit = inputs[2].value.trim();
                    const target = inputs[3].value.trim();
                    if (label && value && target) {
                        mainMetrics.push({ label, value, unit, target });
                    }
                });
            }

            // 서브 KPI 수집
            const subMetrics = [];
            if (document.getElementById('kpiSubMetricsToggle').checked) {
                document.querySelectorAll('#kpiSubMetricsList .kpi-form-item').forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const label = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    const unit = inputs[2].value.trim();
                    const target = inputs[3].value.trim();
                    if (label && value) {
                        subMetrics.push({ label, value, unit, target });
                    }
                });
            }

            // 조건 수집
            const conditions = [];
            if (document.getElementById('kpiConditionsToggle').checked) {
                document.querySelectorAll('#kpiConditionsList textarea').forEach(ta => {
                    const text = ta.value.trim();
                    if (text) {
                        conditions.push(text);
                    }
                });
            }

            // 대시보드 링크 수집 (관리자만)
            let dashboardUrl = '';
            const isAdmin = currentUser && currentUser.isAdmin;
            if (isAdmin) {
                dashboardUrl = document.getElementById('kpiDashboardUrlInput').value.trim();
                if (dashboardUrl && !isValidUrl(dashboardUrl)) {
                    alert('올바른 URL 형식을 입력해주세요.');
                    return;
                }
            }

            // 저장 (dashboardUrl 포함)
            const kpiInfo = { mission, mainMetrics, subMetrics, conditions, dashboardUrl };
            
            if (supabaseClient && SupabaseConfig.enabled) {
                // Supabase에 저장
                const success = await saveKpiToSupabase(curSub, kpiInfo);
                if (success) {
                    await loadKpiFromSupabase();
                }
            } else {
                // localStorage에 저장
                kpiData[curSub] = kpiInfo;
                saveKpiDataToStorage();
                // localStorage 모드에서도 링크 저장
                if (isAdmin) {
                    dashboardLinks[curSub] = dashboardUrl;
                    saveDashboardLinksToStorage();
                }
            }
            
            closeKpiModal();
            renderKpiSection();
            updateLastUpdateTime();
            toast('✅ KPI가 저장되었습니다');
        }

        // KPI 모달 클릭 이벤트
        document.getElementById('kpiModal').addEventListener('click', e => {
            if (e.target.id === 'kpiModal') closeKpiModal();
        });

        // 초기화 시 KPI 데이터 로드
        loadKpiData();

        loadTheme();

        // ========== 로그인 시스템 ==========
        const AUTH_CONFIG = {
            teams: [
                { id: 'sales', name: '영업본부', pin: '8520', subTeams: ['sales_1', 'sales_2', 'sales_3', 'sales_team'] },
                { id: 'estimation', name: '설계/적산팀', pin: '2659', subTeams: ['apt_square'] },
                { id: 'management', name: '경영관리본부', pin: '2026', subTeams: ['mgmt_team', 'growth'] },
                { id: 'brand_team', name: '브랜드마케팅팀', pin: '1234', subTeams: ['brand_team'] },
                { id: 'commerce', name: '커머스사업본부', pin: '8420', subTeams: ['brand_comm', 'media_comm', 'overseas', 'moyeora'] },
                { id: 'rnd', name: '기술연구소', pin: '7329', subTeams: ['rnd_team'] },
                { id: 'factory', name: '용인공장', pin: '9514', subTeams: ['factory_team'] },
                { id: 'admin', name: '🔑 관리자', pin: '8686', isAdmin: true }
            ]
        };

        let currentUser = null; // { id, name, isAdmin, subTeams }

        // 로그인 페이지 표시
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginTeamSelect').value = '';
            clearPinInputs();
            document.getElementById('loginError').textContent = '';
        }

        // 로그인 페이지 숨기기
        function hideLoginPage() {
            document.getElementById('loginPage').classList.add('hidden');
        }

        // 헤더의 로그인 버튼 클릭 시
        function openLoginModal() {
            if (currentUser) {
                // 이미 로그인 되어있으면 로그아웃 확인
                if (confirm('로그아웃 하시겠습니까?')) {
                    logout();
                }
                return;
            }
            showLoginPage();
        }

        function closeLoginModal() {
            hideLoginPage();
        }

        // 통계 모달 함수들
        function openStatModal(type) {
            const modal = document.getElementById('statModal');
            const title = document.getElementById('statModalTitle');
            const body = document.getElementById('statModalBody');
            
            const colors = ['#3B82F6', '#06B6D4', '#10B981', '#EC4899', '#F59E0B', '#8B5CF6', '#6366F1'];
            
            let html = '';
            
            if (type === 'delayed') {
                title.textContent = '지연 KPI (50% 미만)';
                html = renderDelayedKpis(colors);
            } else if (type === 'done') {
                title.textContent = '활성화 KPI (50% 이상)';
                html = renderDoneKpis(colors);
            } else if (type === 'total') {
                title.textContent = '전체 메인 KPI';
                html = renderAllKpis(colors);
            } else if (type === 'members') {
                title.textContent = '참여 인원';
                html = renderMembers(colors);
            }
            
            body.innerHTML = html;
            modal.classList.add('show');
            
            // 모달 밖 클릭시 닫기
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeStatModal();
                }
            };
        }
        
        function closeStatModal() {
            document.getElementById('statModal').classList.remove('show');
        }
        
        function toggleTeamSection(el) {
            const header = el;
            const content = header.nextElementSibling;
            header.classList.toggle('open');
            content.classList.toggle('open');
        }
        
        function toggleSubTeamSection(event, el) {
            event.stopPropagation(); // 부모 클릭 이벤트 방지
            const header = el;
            const content = header.nextElementSibling;
            header.classList.toggle('open');
            content.classList.toggle('open');
        }
        
        function goToTeamKpi(deptId, subId) {
            closeStatModal();
            showDetail(deptId, subId);
        }
        
        function renderDelayedKpis(colors) {
            let html = '';
            let hasDelayed = false;
            
            ORG.departments.forEach((d, dIdx) => {
                // 부서별로 팀 데이터 수집
                let deptTeams = [];
                
                d.subDepts.forEach(s => {
                    const kpi = kpiData[s.id];
                    if (kpi && kpi.mainMetrics) {
                        let teamKpis = [];
                        kpi.mainMetrics.forEach((m, mIdx) => {
                            const current = parseFloat(m.value) || 0;
                            const target = parseFloat(m.target) || 1;
                            const pct = Math.round((current / target) * 100);
                            if (pct < 50) {
                                const kpiName = m.label || m.name || `KPI ${mIdx + 1}`;
                                teamKpis.push({ 
                                    name: kpiName, 
                                    pct,
                                    current,
                                    target,
                                    unit: m.unit || ''
                                });
                                hasDelayed = true;
                            }
                        });
                        if (teamKpis.length > 0) {
                            deptTeams.push({
                                team: s.name,
                                teamId: s.id,
                                deptId: d.id,
                                kpis: teamKpis
                            });
                        }
                    }
                });
                
                if (deptTeams.length > 0) {
                    const totalKpis = deptTeams.reduce((sum, t) => sum + t.kpis.length, 0);
                    html += `
                        <div class="stat-team-section">
                            <div class="stat-team-header" onclick="toggleTeamSection(this)">
                                <div class="stat-team-color" style="background: ${colors[dIdx % colors.length]}"></div>
                                <span class="stat-team-name">${d.name}</span>
                                <span class="stat-team-count">${totalKpis}개</span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="stat-team-content">
                                ${deptTeams.map(t => `
                                    <div class="stat-subteam-section">
                                        <div class="stat-subteam-header" onclick="toggleSubTeamSection(event, this)">
                                            <span class="stat-subteam-name">${t.team}</span>
                                            <span class="stat-subteam-count">${t.kpis.length}개</span>
                                            <span class="arrow">▼</span>
                                        </div>
                                        <div class="stat-subteam-content">
                                            ${t.kpis.map(k => `
                                                <div class="stat-kpi-item" onclick="goToTeamKpi('${t.deptId}', '${t.teamId}')">
                                                    <span class="stat-kpi-name">${k.name} (${k.current}/${k.target}${k.unit})</span>
                                                    <span class="stat-kpi-progress delayed">${k.pct}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasDelayed) {
                html = `<div class="stat-empty"><div class="stat-empty-icon">🎉</div><div>지연된 KPI가 없습니다!</div></div>`;
            }
            
            return html;
        }
        
        function renderDoneKpis(colors) {
            let html = '';
            let hasActive = false;
            
            ORG.departments.forEach((d, dIdx) => {
                // 부서별로 팀 데이터 수집
                let deptTeams = [];
                
                d.subDepts.forEach(s => {
                    const kpi = kpiData[s.id];
                    if (kpi && kpi.mainMetrics) {
                        let teamKpis = [];
                        kpi.mainMetrics.forEach((m, mIdx) => {
                            const current = parseFloat(m.value) || 0;
                            const target = parseFloat(m.target) || 1;
                            const pct = Math.round((current / target) * 100);
                            if (pct >= 50) {
                                const kpiName = m.label || m.name || `KPI ${mIdx + 1}`;
                                teamKpis.push({ 
                                    name: kpiName, 
                                    pct,
                                    current,
                                    target,
                                    unit: m.unit || ''
                                });
                                hasActive = true;
                            }
                        });
                        if (teamKpis.length > 0) {
                            deptTeams.push({
                                team: s.name,
                                teamId: s.id,
                                deptId: d.id,
                                kpis: teamKpis
                            });
                        }
                    }
                });
                
                if (deptTeams.length > 0) {
                    const totalKpis = deptTeams.reduce((sum, t) => sum + t.kpis.length, 0);
                    html += `
                        <div class="stat-team-section">
                            <div class="stat-team-header" onclick="toggleTeamSection(this)">
                                <div class="stat-team-color" style="background: ${colors[dIdx % colors.length]}"></div>
                                <span class="stat-team-name">${d.name}</span>
                                <span class="stat-team-count">${totalKpis}개</span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="stat-team-content">
                                ${deptTeams.map(t => `
                                    <div class="stat-subteam-section">
                                        <div class="stat-subteam-header" onclick="toggleSubTeamSection(event, this)">
                                            <span class="stat-subteam-name">${t.team}</span>
                                            <span class="stat-subteam-count">${t.kpis.length}개</span>
                                            <span class="arrow">▼</span>
                                        </div>
                                        <div class="stat-subteam-content">
                                            ${t.kpis.map(k => `
                                                <div class="stat-kpi-item" onclick="goToTeamKpi('${t.deptId}', '${t.teamId}')">
                                                    <span class="stat-kpi-name">${k.name} (${k.current}/${k.target}${k.unit})</span>
                                                    <span class="stat-kpi-progress ${k.pct >= 100 ? 'done' : ''}">${k.pct >= 100 ? '✓ ' : ''}${k.pct}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasActive) {
                html = `<div class="stat-empty"><div class="stat-empty-icon">📊</div><div>활성화된 KPI가 없습니다</div></div>`;
            }
            
            return html;
        }
        
        function renderAllKpis(colors) {
            let html = '';
            let hasKpi = false;
            
            ORG.departments.forEach((d, dIdx) => {
                // 부서별로 팀 데이터 수집
                let deptTeams = [];
                
                d.subDepts.forEach(s => {
                    const kpi = kpiData[s.id];
                    if (kpi && kpi.mainMetrics && kpi.mainMetrics.length > 0) {
                        let teamKpis = [];
                        kpi.mainMetrics.forEach((m, mIdx) => {
                            const current = parseFloat(m.value) || 0;
                            const target = parseFloat(m.target) || 1;
                            const pct = Math.round((current / target) * 100);
                            const kpiName = m.label || m.name || `KPI ${mIdx + 1}`;
                            teamKpis.push({ 
                                name: kpiName, 
                                pct,
                                current,
                                target,
                                unit: m.unit || ''
                            });
                            hasKpi = true;
                        });
                        if (teamKpis.length > 0) {
                            deptTeams.push({
                                team: s.name,
                                teamId: s.id,
                                deptId: d.id,
                                kpis: teamKpis
                            });
                        }
                    }
                });
                
                if (deptTeams.length > 0) {
                    const totalKpis = deptTeams.reduce((sum, t) => sum + t.kpis.length, 0);
                    html += `
                        <div class="stat-team-section">
                            <div class="stat-team-header" onclick="toggleTeamSection(this)">
                                <div class="stat-team-color" style="background: ${colors[dIdx % colors.length]}"></div>
                                <span class="stat-team-name">${d.name}</span>
                                <span class="stat-team-count">${totalKpis}개</span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="stat-team-content">
                                ${deptTeams.map(t => `
                                    <div class="stat-subteam-section">
                                        <div class="stat-subteam-header" onclick="toggleSubTeamSection(event, this)">
                                            <span class="stat-subteam-name">${t.team}</span>
                                            <span class="stat-subteam-count">${t.kpis.length}개</span>
                                            <span class="arrow">▼</span>
                                        </div>
                                        <div class="stat-subteam-content">
                                            ${t.kpis.map(k => `
                                                <div class="stat-kpi-item" onclick="goToTeamKpi('${t.deptId}', '${t.teamId}')">
                                                    <span class="stat-kpi-name">${k.name} (${k.current}/${k.target}${k.unit})</span>
                                                    <span class="stat-kpi-progress ${k.pct >= 100 ? 'done' : k.pct < 50 ? 'delayed' : ''}">${k.pct}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasKpi) {
                html = `<div class="stat-empty"><div class="stat-empty-icon">📋</div><div>등록된 KPI가 없습니다</div></div>`;
            }
            
            return html;
        }
        
        function renderMembers(colors) {
            let html = '';
            let hasMembers = false;
            
            ORG.departments.forEach((d, dIdx) => {
                // 부서별로 팀 데이터 수집
                let deptTeams = [];
                
                d.subDepts.forEach(s => {
                    const kpi = kpiData[s.id];
                    if (kpi && kpi.mainMetrics && kpi.mainMetrics.length > 0) {
                        let teamMembers = [];
                        s.members.forEach(m => {
                            // 문자열인 경우 파싱, 객체인 경우 그대로 사용
                            let memberName, memberRole;
                            if (typeof m === 'string') {
                                const parts = m.split(' ');
                                memberName = parts[0];
                                memberRole = parts.slice(1).join(' ') || '팀원';
                            } else {
                                memberName = m.name;
                                memberRole = m.role || '팀원';
                            }
                            teamMembers.push({ name: memberName, role: memberRole });
                            hasMembers = true;
                        });
                        if (teamMembers.length > 0) {
                            deptTeams.push({
                                team: s.name,
                                teamId: s.id,
                                deptId: d.id,
                                members: teamMembers
                            });
                        }
                    }
                });
                
                if (deptTeams.length > 0) {
                    const totalMembers = deptTeams.reduce((sum, t) => sum + t.members.length, 0);
                    html += `
                        <div class="stat-team-section">
                            <div class="stat-team-header" onclick="toggleTeamSection(this)">
                                <div class="stat-team-color" style="background: ${colors[dIdx % colors.length]}"></div>
                                <span class="stat-team-name">${d.name}</span>
                                <span class="stat-team-count">${totalMembers}명</span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="stat-team-content">
                                ${deptTeams.map(t => `
                                    <div class="stat-subteam-section">
                                        <div class="stat-subteam-header" onclick="toggleSubTeamSection(event, this)">
                                            <span class="stat-subteam-name">${t.team}</span>
                                            <span class="stat-subteam-count">${t.members.length}명</span>
                                            <span class="arrow">▼</span>
                                        </div>
                                        <div class="stat-subteam-content">
                                            ${t.members.map(m => `
                                                <div class="stat-member-item" onclick="goToTeamKpi('${t.deptId}', '${t.teamId}')" style="cursor: pointer;">
                                                    <div class="stat-member-avatar">${m.name.slice(-2)}</div>
                                                    <div class="stat-member-info">
                                                        <div class="stat-member-name">${m.name}</div>
                                                        <div class="stat-member-role">${m.role}</div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!hasMembers) {
                html = `<div class="stat-empty"><div class="stat-empty-icon">👥</div><div>참여 인원이 없습니다</div></div>`;
            }
            
            return html;
        }

        function clearPinInputs() {
            const inputs = document.querySelectorAll('.pin-input');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
            });
            inputs[0]?.focus();
        }

        function handlePinInput(e, index) {
            const input = e.target;
            const inputs = document.querySelectorAll('.pin-input');
            
            // 숫자만 허용
            input.value = input.value.replace(/[^0-9]/g, '');
            
            if (input.value) {
                input.classList.add('filled');
                // 다음 입력칸으로 이동
                if (index < 3) {
                    inputs[index + 1].focus();
                }
            } else {
                input.classList.remove('filled');
            }
            
            // 에러 상태 제거
            inputs.forEach(i => i.classList.remove('error'));
            document.getElementById('loginError').textContent = '';
            
            // 4자리 모두 입력되면 자동 로그인 시도
            const pin = Array.from(inputs).map(i => i.value).join('');
            if (pin.length === 4) {
                attemptLogin();
            }
        }

        function handlePinKeydown(e, index) {
            const inputs = document.querySelectorAll('.pin-input');
            
            // 백스페이스 처리
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
        }

        function attemptLogin() {
            const teamId = document.getElementById('loginTeamSelect').value;
            const inputs = document.querySelectorAll('.pin-input');
            const pin = Array.from(inputs).map(i => i.value).join('');
            
            if (!teamId) {
                document.getElementById('loginError').textContent = '팀을 선택해주세요';
                return;
            }
            
            if (pin.length !== 4) {
                document.getElementById('loginError').textContent = 'PIN 4자리를 입력해주세요';
                return;
            }
            
            const team = AUTH_CONFIG.teams.find(t => t.id === teamId);
            
            if (team && team.pin === pin) {
                // 로그인 성공
                currentUser = {
                    id: team.id,
                    name: team.name.replace('🔑 ', ''),
                    isAdmin: team.isAdmin || false,
                    subTeams: team.subTeams || []
                };
                
                hideLoginPage();
                updateLoginStatus();
                updateUIForAuth();
                toast(`✅ ${currentUser.name}으로 로그인되었습니다`);
            } else {
                // 로그인 실패
                inputs.forEach(i => i.classList.add('error'));
                document.getElementById('loginError').textContent = 'PIN이 올바르지 않습니다';
            }
        }

        function logout() {
            currentUser = null;
            updateLoginStatus();
            updateUIForAuth();
            showLoginPage(); // 로그아웃 시 로그인 페이지로 이동
            toast('👋 로그아웃되었습니다');
        }

        function guestMode() {
            hideLoginPage();
            toast('👀 조회 모드로 접속합니다');
        }

        function updateLoginStatus() {
            const statusEl = document.getElementById('loginStatus');
            const sidebarUserInfo = document.getElementById('sidebarUserInfo');
            const sidebarUserName = document.getElementById('sidebarUserName');
            
            if (currentUser) {
                statusEl.className = 'login-status logged-in';
                statusEl.innerHTML = `
                    <span class="login-status-icon">👤</span>
                    <span class="login-status-text">${currentUser.name}</span>
                    <button class="login-status-btn" onclick="event.stopPropagation(); logout();">로그아웃</button>
                `;
                
                // 사이드바 하단 로그인 정보 표시
                sidebarUserInfo.style.display = 'flex';
                sidebarUserName.textContent = currentUser.name;
            } else {
                statusEl.className = 'login-status';
                statusEl.innerHTML = `
                    <span class="login-status-icon">🔐</span>
                    <span class="login-status-text">로그인</span>
                `;
                
                // 사이드바 하단 로그인 정보 숨기기
                sidebarUserInfo.style.display = 'none';
            }
        }

        function updateUIForAuth() {
            // 모든 수정/삭제 버튼 업데이트
            updateKpiButtons();
            renderInitiatives();
            renderDetail();
        }

        function canEditTeam(teamId) {
            if (!currentUser) return false;
            if (currentUser.isAdmin) return true;
            // subTeams 배열에 해당 팀이 포함되어 있는지 확인
            return currentUser.subTeams && currentUser.subTeams.includes(teamId);
        }

        function updateKpiButtons() {
            // KPI 설정 버튼 표시/숨김
            const kpiSetupBtn = document.getElementById('kpiSetupBtn');
            if (kpiSetupBtn) {
                kpiSetupBtn.style.display = canEditTeam(curSub) ? 'block' : 'none';
            }
        }

        // 페이지 로드 시 로그인 상태 확인
        updateLoginStatus();
    </script>

    <!-- 로그인 페이지 (전체 화면) -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">
                        <img src="https://raw.githubusercontent.com/netformrnd-lab/netform-kpi-dashboard-BS/main/logo.jpg" alt="Netform R&D" class="login-logo-img">
                    </div>
                    <div class="login-title">팀 로그인</div>
                    <div class="login-subtitle">팀을 선택하고 PIN을 입력하세요</div>
                </div>
                
                <div class="login-form-group">
                    <label class="login-label">팀 선택</label>
                    <select class="login-select" id="loginTeamSelect">
                        <option value="">팀을 선택하세요</option>
                        <option value="sales">영업본부</option>
                        <option value="estimation">설계/적산팀</option>
                        <option value="management">경영관리본부</option>
                        <option value="brand_team">브랜드마케팅팀</option>
                        <option value="commerce">커머스사업본부</option>
                        <option value="rnd">기술연구소</option>
                        <option value="factory">용인공장</option>
                        <option disabled>──────────</option>
                        <option value="admin">🔑 관리자</option>
                    </select>
                </div>
                
                <div class="login-form-group">
                    <label class="login-label">PIN 입력</label>
                    <div class="pin-input-container">
                        <input type="text" class="pin-input" maxlength="1" inputmode="numeric" 
                               oninput="handlePinInput(event, 0)" onkeydown="handlePinKeydown(event, 0)">
                        <input type="text" class="pin-input" maxlength="1" inputmode="numeric"
                               oninput="handlePinInput(event, 1)" onkeydown="handlePinKeydown(event, 1)">
                        <input type="text" class="pin-input" maxlength="1" inputmode="numeric"
                               oninput="handlePinInput(event, 2)" onkeydown="handlePinKeydown(event, 2)">
                        <input type="text" class="pin-input" maxlength="1" inputmode="numeric"
                               oninput="handlePinInput(event, 3)" onkeydown="handlePinKeydown(event, 3)">
                    </div>
                    <div class="login-error" id="loginError"></div>
                </div>
                
                <button class="login-btn" onclick="attemptLogin()">로그인</button>
                
                <div class="login-divider">또는</div>
                
                <button class="login-guest-btn" onclick="guestMode()">
                    로그인 없이 둘러보기
                </button>
            </div>
        </div>
    </div>

    <!-- 통계 모달 -->
    <div class="modal stat-modal" id="statModal">
        <div class="modal-box stat-modal-box">
            <div class="stat-modal-header">
                <h3 class="stat-modal-title" id="statModalTitle">지연 KPI</h3>
                <button class="modal-close" onclick="closeStatModal()">×</button>
            </div>
            <div class="stat-modal-body" id="statModalBody">
                <!-- 동적 콘텐츠 -->
            </div>
        </div>
    </div>
</body>
</html>
